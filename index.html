<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vic's Match System - ç¾½çƒè¨ˆåˆ†ç³»çµ±</title> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { --bg-color: #f0f7f4; --primary: #4ecdc4; --secondary: #ff6b6b; --accent: #ffe66d; --text-main: #2f3e46; --card-bg: #ffffff; }
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; overflow-x: hidden; }
        
        .page { display: none; min-height: 100vh; padding: 20px; box-sizing: border-box; flex-direction: column; align-items: center; }
        .active-page { display: flex; }

        .btn { padding: 15px 25px; border-radius: 50px; border: none; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); margin: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: inline-block; text-decoration: none; }
        .btn:active { transform: scale(0.92) !important; }

        .btn-primary { background-color: var(--primary); color: white; }
        .btn-outline { background: white; border: 2px solid var(--primary); color: var(--primary); }
        .btn-secondary { background-color: var(--secondary); color: white; }

        .court-btn { padding: 30px; border-radius: 20px; border: 2px solid #eee; background: white; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.05); width: 100%; }
        .court-btn:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-5px); }

        .admin-entry { margin-top: auto; padding-bottom: 40px; text-align: center; cursor: pointer; color: #222; }
        .back-fab { position: fixed; right: 20px; bottom: 20px; width: 55px; height: 55px; background: var(--secondary); color: white; border-radius: 50%; display: none; justify-content: center; align-items: center; z-index: 90; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        
        .scoreboard { width: 100%; max-width: 500px; background: white; border-radius: 25px; padding: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .score-num { font-size: 5rem; font-weight: 900; margin: 0; cursor: pointer; user-select: none; transition: color 0.2s; }
        .serving-dot { width: 12px; height: 12px; background: var(--secondary); border-radius: 50%; margin: 5px auto; visibility: hidden; }
        .serving-active { visibility: visible; }
        .deuce-alert { color: var(--secondary); font-weight: 900; font-size: 2.2rem; animation: pulse 1s infinite; display: none; margin-top: 5px; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); display: none; justify-content: center; align-items: center; z-index: 100; color: white; text-align: center; }
        .admin-box { background: white; width: 100%; max-width: 450px; padding: 20px; border-radius: 20px; margin-top: 15px; border: 2px solid #ddd; box-sizing: border-box; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1rem; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="game-over-overlay" class="overlay">
        <div class="animate__animated animate__zoomIn">
            <h2 id="winner-text" style="font-size: 2.5rem; color: var(--primary);">ç²å‹ï¼</h2>
            <div id="final-score-display" style="font-size: 4rem; font-weight: 900; margin-bottom: 25px;">0 : 0</div>
            <button class="btn btn-primary" style="width: 85%;" onclick="confirmNextSet()">ä¸‹ä¸€å±€ / çµæŸ</button><br>
            <button class="btn btn-outline" style="background:transparent; color:white; border-color:white; margin-top:20px; width: 85%;" onclick="undo()">ä¿®æ­£æœ€å¾Œä¸€åˆ† (Undo)</button>
        </div>
    </div>

    <div id="home-page" class="page active-page">
        <div id="home-logo-display" style="font-size: 60px; margin-top: 40px; min-height: 120px; display: flex; align-items: center;">ğŸ¸</div>
        <h1 style="color: var(--primary); margin-bottom: 30px;">Vic è³½äº‹ç³»çµ±</h1>
        <button class="btn btn-primary" style="width: 250px;" onclick="showPage('staff-verify-page')">å·¥ä½œäººå“¡å…¥å£</button>
        <button class="btn btn-outline" style="width: 250px;" onclick="showPage('player-hub-page')">é¸æ‰‹/è§€çœ¾å¤§å»³</button>
        <div class="admin-entry" onclick="adminLogin()">âš™ï¸<br>å¾Œå°ç®¡ç†</div>
    </div>

    <div id="staff-verify-page" class="page">
        <h2>å·¥ä½œäººå“¡ç™»å…¥</h2>
        <input type="password" id="staff-pass" placeholder="è¼¸å…¥è£åˆ¤å¯†ç¢¼ (1234)" style="max-width:300px;">
        <button class="btn btn-primary" onclick="verifyStaff()">ä¸‹ä¸€æ­¥</button>
    </div>

    <div id="staff-select-page" class="page">
        <h2>åŸ·æ³•è£åˆ¤ç™»è¨˜</h2>
        <div class="admin-box">
            <select id="staff-name-list">
                <option value="">-- è«‹é¸æ“‡ --</option>
                <option value="Vic">Vic</option><option value="Leo">Leo</option><option value="Amy">Amy</option><option value="å…¶ä»–">æ‰‹å‹•è¼¸å…¥...</option>
            </select>
            <div id="manual-name-group" style="display:none; margin-top:10px;"><input type="text" id="staff-name-manual" placeholder="è«‹è¼¸å…¥å§“å"></div>
            <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="confirmStaff()">ç¢ºå®šé€²å…¥</button>
        </div>
    </div>

    <div id="court-selection-page" class="page">
        <div id="current-judge-tag" style="font-size: 0.9rem; color: #666;">ç›®å‰è£åˆ¤ï¼šæœªç™»éŒ„</div>
        <h2 style="margin-bottom: 30px;">é¸æ“‡åŸ·æ³•å ´åœ°</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; width:100%; max-width:450px;">
            <button class="court-btn" onclick="selectCourt('1')">å ´åœ° 1</button>
            <button class="court-btn" onclick="selectCourt('2')">å ´åœ° 2</button>
            <button class="court-btn" onclick="selectCourt('3')">å ´åœ° 3</button>
            <button class="court-btn" onclick="selectCourt('4')">å ´åœ° 4</button>
            <button class="court-btn" onclick="selectCourt('5')">å ´åœ° 5</button>
            <button class="court-btn" onclick="selectCourt('6')">å ´åœ° 6</button>
        </div>
    </div>

    <div id="pre-game-page" class="page">
        <h2 id="setup-title">å ´åœ°è¨­å®š <span id="current-rule-display" style="font-size: 0.8rem; color: var(--secondary);">è¼‰å…¥ä¸­...</span></h2>
        <div class="input-group" style="max-width:300px;">
            <label>éšŠä¼ A</label><input type="text" id="teamA-names" placeholder="åç¨±">
            <br><br>
            <label>éšŠä¼ B</label><input type="text" id="teamB-names" placeholder="åç¨±">
        </div>
        <button class="btn btn-primary" onclick="startMatch()">é–‹å§‹æ¯”è³½</button>
    </div>

    <div id="scoring-page" class="page">
        <div id="current-set-label" style="background:var(--accent); padding:5px 15px; border-radius:15px; font-weight:bold;">ç¬¬ 1 å±€</div>
        <div class="scoreboard" style="margin-top:10px;">
            <div id="team-container" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1; text-align: center;">
                    <div id="set-won-A" style="color: var(--secondary); font-size: 0.8rem;">Sets: 0</div>
                    <div id="dot-A" class="serving-dot"></div>
                    <div id="score-A" class="score-num" onclick="addScore('A')">0</div>
                    <div id="display-nameA" style="font-weight:bold">A éšŠ</div>
                </div>
                <div style="text-align: center; min-width: 60px;">
                    <div>VS</div>
                    <div id="status-note" class="deuce-alert">DEUCE</div>
                </div>
                <div style="flex: 1; text-align: center;">
                    <div id="set-won-B" style="color: var(--secondary); font-size: 0.8rem;">Sets: 0</div>
                    <div id="dot-B" class="serving-dot"></div>
                    <div id="score-B" class="score-num" onclick="addScore('B')">0</div>
                    <div id="display-nameB" style="font-weight:bold">B éšŠ</div>
                </div>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; max-width: 500px; margin-top: 15px;">
            <button class="btn btn-outline" onclick="undo()">â†©ï¸ æ¢å¾©</button>
            <button class="btn btn-outline" onclick="switchSide()">ğŸ”„ æ›é‚Š</button>
            <button class="btn btn-outline" onclick="manualServe()">ğŸ¸ ç™¼çƒ</button>
            <button class="btn btn-secondary" onclick="resetMatch()">âš ï¸ é‡è¨­</button>
        </div>
        <div style="font-size: 0.8rem; color:#888; margin-top:10px;">åŸ·æ³•è£åˆ¤ï¼š<span id="scoring-judge-name">-</span></div>
    </div>

    <div id="player-hub-page" class="page">
        <h1>è³½äº‹è³‡è¨Šå¤§å»³</h1>
        <div class="admin-box" style="border:none; text-align:center; background: rgba(78, 205, 196, 0.1);">
            <h3 id="announcement-text">è¼‰å…¥ä¸­...</h3>
            <img id="schedule-img-display" src="" style="max-width:100%; border-radius:10px; display:none; margin-top:10px;">
        </div>
        <div style="margin-top: 20px; font-weight: bold; color: var(--primary);">ğŸ”´ LIVE å³æ™‚è³½æ³</div>
        <div id="live-scoreboard-grid" style="display: grid; grid-template-columns: 1fr; gap: 15px; width: 100%; max-width: 500px; padding: 10px;"></div>
        <button class="btn btn-primary" onclick="showPage('home-page')">è¿”å›é¦–é </button>
    </div>

    <div id="admin-master-page" class="page">
        <h1 style="color: var(--secondary);">ğŸ› ï¸ ç®¡ç†å¾Œå°</h1>
        <div class="admin-box">
            <h4>1. åˆ†åˆ¶èˆ‡å…¬å‘Š</h4>
            <select id="admin-court-select"><option value="1">å ´åœ° 1</option><option value="2">å ´åœ° 2</option><option value="3">å ´åœ° 3</option><option value="4">å ´åœ° 4</option><option value="5">å ´åœ° 5</option><option value="6">å ´åœ° 6</option></select>
            <select id="rule-score-target" style="margin-top:10px;"><option value="11">11 åˆ†åˆ¶</option><option value="15">15 åˆ†åˆ¶</option><option value="21">21 åˆ†åˆ¶</option></select>
            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="updateCourtRule()">å¥—ç”¨åˆ†åˆ¶</button>
            <hr>
            <textarea id="admin-announcement" placeholder="å…¬å‘Šå…§å®¹..."></textarea>
            <input type="text" id="admin-img-url" placeholder="è³½ç¨‹åœ–ç¶²å€..." style="margin-top:10px;">
            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="publishNotice()">ç™¼å¸ƒå…¬å‘Š</button>
        </div>
        <div class="admin-box">
            <h4>2. ç³»çµ±å°é¢ Logo</h4>
            <input type="text" id="admin-logo-url" placeholder="è²¼ä¸Š Logo åœ–ç‰‡ç¶²å€...">
            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="updateLogo()">æ›´æ–°å°é¢ç…§ç‰‡</button>
        </div>
        <button class="btn btn-outline" onclick="showPage('home-page')">é€€å‡ºå¾Œå°</button>
    </div>

    <button id="global-back-btn" class="back-fab" onclick="smartBack()">ğŸ”™</button>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAbj5MjkqNMCUwIM5b2Mbyw1OeJ55uZvMw",
        authDomain: "badminton-scorer-9c881.firebaseapp.com",
        projectId: "badminton-scorer-9c881",
        storageBucket: "badminton-scorer-9c881.firebasestorage.app",
        messagingSenderId: "83500315105",
        appId: "1:83500315105:web:852112812e448efbb6e2a0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentCourt = null;
    let loggedJudge = "";

    // --- å¤§å»³åˆå§‹åŒ– ---
    const courts = ['1', '2', '3', '4', '5', '6'];
    const gridEl = document.getElementById('live-scoreboard-grid');
    gridEl.innerHTML = courts.map(id => `
        <div id="hub-court-${id}" style="background: white; border-radius: 15px; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-left: 5px solid #ddd;">
            <div style="text-align: left;">
                <div style="font-size: 0.7rem; color: #888;">COURT ${id}</div>
                <div id="hub-names-${id}" style="font-weight: bold; font-size: 0.9rem;">æº–å‚™ä¸­</div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <div id="hub-score-${id}" style="font-size: 1.4rem; font-weight: 900; color: var(--primary);">0 : 0</div>
                <div id="hub-set-${id}" style="font-size: 0.6rem; background: #eee; padding: 2px 5px; border-radius: 4px;">Set 1</div>
            </div>
        </div>
    `).join('');

    // --- ç›£è½å¤§å»³æ•¸æ“š ---
    courts.forEach(id => {
        onSnapshot(doc(db, "games", id), (snap) => {
            if (snap.exists()) {
                const d = snap.data();
                const target = d.targetScore || 21;
                const sA = d.scoreA, sB = d.scoreB;
                const scoreEl = document.getElementById(`hub-score-${id}`);
                
                document.getElementById(`hub-names-${id}`).innerText = `${d.nameA} vs ${d.nameB}`;
                document.getElementById(`hub-set-${id}`).innerText = `Set ${d.currentSet}`;
                scoreEl.innerText = `${sA} : ${sB}`;

                // å¤§å»³é¡è‰²é‚è¼¯ï¼šé ˜å…ˆä¸”é”åˆ°å±€é»æ‰è®Šç´…
                const isSomeoneLeadingAtGP = (sA >= target - 1 || sB >= target - 1) && (sA !== sB);
                scoreEl.style.color = isSomeoneLeadingAtGP ? "var(--secondary)" : "var(--primary)";
                document.getElementById(`hub-court-${id}`).style.borderColor = (sA > 0 || sB > 0) ? "var(--primary)" : "#ddd";
            }
        });
    });

    // --- è¨ˆåˆ†é é¢ UI æ›´æ–° ---
    function updateUI(data) {
        const sA = data.scoreA, sB = data.scoreB, target = data.targetScore || 21;
        const elA = document.getElementById('score-A');
        const elB = document.getElementById('score-B');
        
        elA.innerText = sA;
        elB.innerText = sB;

        // çµ•å°é ˜å…ˆåˆ¤æ–·ï¼šåªæœ‰æˆ‘æ˜¯æœ€é«˜åˆ†ï¼Œä¸”é”åˆ°å±€é»é–€æª»æ‰è®Šç´…
        const isGamePointA = (sA >= target - 1) && (sA > sB);
        const isGamePointB = (sB >= target - 1) && (sB > sA);

        elA.style.color = isGamePointA ? "var(--secondary)" : "var(--text-main)";
        elB.style.color = isGamePointB ? "var(--secondary)" : "var(--text-main)";

        document.getElementById('current-rule-display').innerText = `${target}åˆ†åˆ¶`;
        document.getElementById('display-nameA').innerText = data.nameA;
        document.getElementById('display-nameB').innerText = data.nameB;
        document.getElementById('set-won-A').innerText = `Sets: ${data.setsA}`;
        document.getElementById('set-won-B').innerText = `Sets: ${data.setsB}`;
        document.getElementById('current-set-label').innerText = `ç¬¬ ${data.currentSet} å±€ (${target}åˆ†)`;
        document.getElementById('scoring-judge-name').innerText = data.judgeName || "-";
        document.getElementById('dot-A').className = data.server === 'A' ? 'serving-dot serving-active' : 'serving-dot';
        document.getElementById('dot-B').className = data.server === 'B' ? 'serving-dot serving-active' : 'serving-dot';
        
        // DEUCE æé†’ (å¹³æ‰‹ä¸”å¤§æ–¼é–€æª»)
        document.getElementById('status-note').style.display = (sA >= target-1 && sB >= target-1 && sA === sB) ? 'block' : 'none';
    }

    // --- å…¶ä»–åŠŸèƒ½å‡½æ•¸ ---
    window.showPage = (id) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
        document.getElementById(id).classList.add('active-page');
        document.getElementById('global-back-btn').style.display = (id === 'home-page') ? 'none' : 'flex';
        window.scrollTo(0, 0);
    };
    window.smartBack = () => showPage('home-page');
    window.verifyStaff = () => { if(document.getElementById('staff-pass').value==='1234') showPage('staff-select-page'); else alert('å¯†ç¢¼éŒ¯èª¤'); };
    document.getElementById('staff-name-list').addEventListener('change', (e) => { document.getElementById('manual-name-group').style.display = (e.target.value==='å…¶ä»–') ? 'block' : 'none'; });
    window.confirmStaff = () => {
        const val = document.getElementById('staff-name-list').value;
        loggedJudge = (val === 'å…¶ä»–') ? document.getElementById('staff-name-manual').value : val;
        if(!loggedJudge) return alert("è«‹è¼¸å…¥å§“å");
        document.getElementById('current-judge-tag').innerText = `ç›®å‰è£åˆ¤ï¼š${loggedJudge}`;
        showPage('court-selection-page');
    };
    window.adminLogin = () => { if(prompt("ç®¡ç†å“¡å¯†ç¢¼")==='9999') showPage('admin-master-page'); };
    window.updateCourtRule = async () => {
        const id = document.getElementById('admin-court-select').value;
        const target = parseInt(document.getElementById('rule-score-target').value);
        await updateDoc(doc(db, "games", id), { targetScore: target });
        alert(`å ´åœ° ${id} å·²è®Šæ›´ç‚º ${target} åˆ†åˆ¶`);
    };
    window.publishNotice = async () => {
        await setDoc(doc(db, "config", "announcement"), { content: document.getElementById('admin-announcement').value, imgUrl: document.getElementById('admin-img-url').value });
        alert("å…¬å‘Šå·²æ›´æ–°");
    };
    window.updateLogo = async () => {
        await setDoc(doc(db, "config", "appearance"), { logoUrl: document.getElementById('admin-logo-url').value });
        alert("Logo å·²æ›´æ–°");
    };
    onSnapshot(doc(db, "config", "announcement"), (snap) => {
        if(snap.exists()){
            const d = snap.data();
            document.getElementById('announcement-text').innerText = d.content || "æš«ç„¡å…¬å‘Š";
            const img = document.getElementById('schedule-img-display');
            if(d.imgUrl) { img.src = d.imgUrl; img.style.display = 'block'; } else img.style.display = 'none';
        }
    });
    onSnapshot(doc(db, "config", "appearance"), (snap) => {
        if(snap.exists()){
            const d = snap.data();
            const div = document.getElementById('home-logo-display');
            div.innerHTML = d.logoUrl ? `<img src="${d.logoUrl}" style="max-width:180px; max-height:180px; border-radius:20px;">` : "ğŸ¸";
            div.style.fontSize = d.logoUrl ? "0px" : "60px";
        }
    });
    window.selectCourt = (id) => { currentCourt = id; showPage('pre-game-page'); listenToCourt(id); };
    function listenToCourt(id) {
        onSnapshot(doc(db, "games", id), (snap) => {
            if (snap.exists()) {
                const data = snap.data();
                updateUI(data);
                if (data.isWaitingNext && document.getElementById('game-over-overlay').style.display !== 'flex') {
                    showWinnerOverlay(data.scoreA > data.scoreB ? data.nameA : data.nameB, data.scoreA, data.scoreB);
                }
            }
        });
    }
    window.startMatch = async () => {
        const docRef = doc(db, "games", currentCourt);
        const snap = await getDoc(docRef);
        const target = snap.exists() ? (snap.data().targetScore || 21) : 21;
        await setDoc(docRef, { scoreA: 0, scoreB: 0, setsA: 0, setsB: 0, nameA: document.getElementById('teamA-names').value || "A éšŠ", nameB: document.getElementById('teamB-names').value || "B éšŠ", currentSet: 1, server: 'A', history: [], isWaitingNext: false, targetScore: target, judgeName: loggedJudge });
        showPage('scoring-page');
    };
    window.addScore = async (team) => {
        const docRef = doc(db, "games", currentCourt);
        const d = (await getDoc(docRef)).data();
        const target = d.targetScore || 21;
        let nA = team === 'A' ? d.scoreA + 1 : d.scoreA;
        let nB = team === 'B' ? d.scoreB + 1 : d.scoreB;
        const win = (nA >= target && nA-nB >= 2) || (nB >= target && nB-nA >= 2) || nA === target+9 || nB === target+9;
        const hist = d.history || []; hist.push({scoreA: d.scoreA, scoreB: d.scoreB, server: d.server});
        await updateDoc(docRef, { scoreA: nA, scoreB: nB, server: team, history: hist.slice(-10), isWaitingNext: win });
    };
    window.confirmNextSet = async () => {
        const docRef = doc(db, "games", currentCourt);
        const d = (await getDoc(docRef)).data();
        const winner = d.scoreA > d.scoreB ? 'A' : 'B';
        await updateDoc(docRef, { setsA: winner==='A'?d.setsA+1:d.setsA, setsB: winner==='B'?d.setsB+1:d.setsB, scoreA: 0, scoreB: 0, currentSet: d.currentSet+1, server: winner, isWaitingNext: false, history: [] });
        document.getElementById('game-over-overlay').style.display = 'none';
    };
    function showWinnerOverlay(name, sA, sB) { 
        document.getElementById('winner-text').innerText = `${name} ç²å‹ï¼`; 
        document.getElementById('final-score-display').innerText = `${sA} : ${sB}`;
        document.getElementById('game-over-overlay').style.display = 'flex'; 
    }
    window.undo = async () => {
        const docRef = doc(db, "games", currentCourt);
        const d = (await getDoc(docRef)).data();
        if (d.history && d.history.length > 0) { 
            const last = d.history.pop(); 
            await updateDoc(docRef, { ...last, history: d.history, isWaitingNext: false }); 
        }
        document.getElementById('game-over-overlay').style.display = 'none';
    };
    window.switchSide = () => { const c = document.getElementById('team-container'); c.style.flexDirection = (c.style.flexDirection==='row-reverse') ? 'row' : 'row-reverse'; };
    window.manualServe = async () => { const docRef = doc(db, "games", currentCourt); const s = (await getDoc(docRef)).data().server; await updateDoc(docRef, { server: (s==='A'?'B':'A') }); };
    window.resetMatch = async () => { if (confirm("ç¢ºå®šè¦é‡è¨­æ¯”è³½å—ï¼Ÿ")) startMatch(); };
</script>
</body>
</html>
