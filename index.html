<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vic's Match System - ç¾½çƒè¨ˆåˆ†ç³»çµ±</title> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { --bg-color: #f0f7f4; --primary: #4ecdc4; --secondary: #ff6b6b; --accent: #ffe66d; --text-main: #2f3e46; --card-bg: #ffffff; }
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; overflow-x: hidden; }
        
        .page { display: none; min-height: 100vh; padding: 20px; box-sizing: border-box; flex-direction: column; align-items: center; }
        .active-page { display: flex; }
        .admin-entry:hover { 
            transform: scale(1.1) translateY(-5px); /* è®“é½’è¼ªä¹Ÿæµ®èµ·ä¾† */
            color: var(--secondary); 
        }
        .admin-entry:active { 
            transform: scale(0.9); 
        }
    /* --- çµ±ä¸€æŒ‰éˆ•åŸºç¤æ¨£å¼ --- */
        .btn {
            padding: 15px 25px; 
            border-radius: 50px; 
            border: none; 
            font-size: 1rem; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            margin: 10px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            display: inline-block;
            text-decoration: none;
        }

        /* æŒ‰å£“å›é¥‹ */
        .btn:active { transform: scale(0.92) !important; box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important; }

        /* å·¥ä½œäººå“¡å…¥å£ - æ‡¸åœæ™‚è®Šæ·±ç¶  */
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover {
            background-color: #3dbbb3; 
            transform: translateY(-5px); 
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.4);
        }

        /* é¸æ‰‹å…¥å£ - æ‡¸åœæ™‚å¡«æ»¿æ·¡ç¶ è‰² */
        .btn-outline { background: white; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover {
            background-color: #e0f2f1; /* æ·¡æ·¡çš„ç¶ è‰²èƒŒæ™¯ï¼Œèˆ‡ä¸»æŒ‰éˆ•åšå€éš” */
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.2);
        }

        /* ç®¡ç†å…¥å£å€åŸŸ - çµ±ä¸€ç®¡ç† */
        .admin-entry {
            margin-top: auto; 
            padding-bottom: 40px; 
            text-align: center; 
            cursor: pointer; 
            color: #222; 
            transition: all 0.3s ease;
        }
        .admin-entry:hover { 
            transform: scale(1.1) translateY(-5px); 
            color: var(--secondary); 
        }
        .admin-entry:active { transform: scale(0.9); }
        .back-fab { position: fixed; right: 20px; bottom: 20px; width: 55px; height: 55px; background: var(--secondary); color: white; border-radius: 50%; display: none; justify-content: center; align-items: center; font-size: 20px; z-index: 90; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        .scoreboard { width: 100%; max-width: 500px; background: white; border-radius: 25px; padding: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .score-num { font-size: 5rem; font-weight: 900; margin: 0; cursor: pointer; user-select: none; }
        .serving-dot { width: 12px; height: 12px; background: var(--secondary); border-radius: 50%; margin: 5px auto; visibility: hidden; }
        .serving-active { visibility: visible; }

        /* --- é‡è¨­æŒ‰éˆ• (Secondary) å¹³å¸¸èˆ‡æ‡¸åœç‹€æ…‹ --- */
        .btn-secondary {
            background-color: var(--secondary); /* ä½¿ç”¨ä½ å®šç¾©çš„ç´…è‰² #ff6b6b */
            color: white;
        }

        .btn-secondary:hover {
            background-color: #ff5252; /* æ‡¸åœæ™‚è®Šæ·±ä¸€é»çš„ç´… */
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
        }
        /* --- å„ªåŒ–å¾Œçš„å ´åœ°æŒ‰éˆ• --- */
        .court-btn {
            padding: 30px;
            border-radius: 20px; /* æ›´æœ‰è³ªæ„Ÿçš„åœ“è§’ */
            border: 2px solid #eee; /* æ·ºç°è‰²å¤–æ¡† */
            background: white;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        /* å ´åœ°æŒ‰éˆ•æ»‘é¼ ç§»å…¥ï¼šè®Šæ›é‚Šæ¡†é¡è‰²ä¸¦æµ®èµ· */
        .court-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-8px);
            box-shadow: 0 12px 25px rgba(78, 205, 196, 0.15);
        }

        /* å ´åœ°æŒ‰éˆ•é»æ“Šï¼šç¸®å°å›é¥‹ */
        .court-btn:active {
            transform: scale(0.9);
            background-color: #f9f9f9;
}
        /* å¼·åŒ–å¾Œçš„ DEUCE æé†’ */
        .deuce-alert { 
            color: var(--secondary); 
            font-weight: 900; 
            font-size: 2.2rem; 
            animation: pulse 1s infinite; 
            display: none; 
            margin-top: 5px; 
            white-space: nowrap; 
        }
        .game-point { color: var(--secondary) !important; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* ç²å‹çµç®—èƒŒæ™¯ */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); display: none; justify-content: center; align-items: center; z-index: 100; color: white; text-align: center; }

        .admin-box { background: white; width: 100%; max-width: 450px; padding: 20px; border-radius: 20px; margin-top: 15px; border: 2px solid #ddd; }
        .input-group { margin: 15px 0; width: 100%; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1rem; }
        
        #schedule-img-display { max-width: 100%; border-radius: 15px; margin-top: 15px; display: none; }
    </style>
</head>
<body>

    <div id="pre-game-page" class="page">
        <h2 id="setup-title">å ´åœ°è¨­å®š <span id="current-rule-display" style="font-size: 1rem; color: var(--secondary); background: #fff; padding: 2px 10px; border-radius: 10px; border: 1px solid var(--secondary);">è¼‰å…¥ä¸­...</span></h2>
        <div class="input-group" style="max-width:300px;">
            <label>éšŠä¼/é¸æ‰‹ A</label><input type="text" id="teamA-names" placeholder="éšŠä¼/é¸æ‰‹ A åç¨±">
            <br><br>
            <label>éšŠä¼/é¸æ‰‹ B</label><input type="text" id="teamB-names" placeholder="éšŠä¼/é¸æ‰‹ B åç¨±">
        </div>
        <button class="btn btn-primary" onclick="startMatch()">é–‹å§‹æ¯”è³½</button>
    </div>

    <div id="home-page" class="page active-page">
        <div class="animate__animated animate__fadeInDown" style="font-size: 60px; margin-top: 40px;">ğŸ¸</div>
        <h1 style="color: var(--primary); margin-bottom: 30px;">Vic è³½äº‹ç³»çµ±</h1>
        
        <button class="btn btn-primary" style="width: 250px;" onclick="showPage('staff-verify-page')">å·¥ä½œäººå“¡å…¥å£</button>
        <button class="btn btn-outline" style="width: 250px;" onclick="showPage('player-hub-page')">é¸æ‰‹/è§€çœ¾å¤§å»³</button>
        
        <div class="admin-entry" onclick="adminLogin()">
            <div style="font-size: 35px; margin-bottom: 5px;">âš™ï¸</div>
            <div style="font-size: 1rem; font-weight: 900; letter-spacing: 1px;">å¾Œå°ä¸»æ§ç®¡ç†</div>
        </div>
    </div>

    <div id="staff-verify-page" class="page">
        <h2>å·¥ä½œäººå“¡ç™»å…¥</h2>
        <div class="input-group" style="max-width:300px;">
            <input type="password" id="staff-pass" placeholder="è¼¸å…¥è£åˆ¤å¯†ç¢¼ (1234)">
        </div>
        <button class="btn btn-primary" onclick="verifyStaff()">ä¸‹ä¸€æ­¥</button>
    </div>

    <div id="staff-select-page" class="page">
        <h2>åŸ·æ³•è£åˆ¤ç™»è¨˜</h2>
        <div class="admin-box">
            <div class="input-group">
                <label>é¸æ“‡äººå“¡ï¼š</label>
                <select id="staff-name-list">
                    <option value="">-- è«‹é¸æ“‡ --</option>
                    <option value="Vic">Vic</option>
                    <option value="Leo">Leo</option>
                    <option value="Amy">Amy</option>
                    <option value="å…¶ä»–">æ‰‹å‹•è¼¸å…¥...</option>
                </select>
            </div>
            <div class="input-group" id="manual-name-group" style="display:none;">
                <label>æ‰‹å‹•è¼¸å…¥å§“åï¼š</label>
                <input type="text" id="staff-name-manual" placeholder="è«‹è¼¸å…¥å§“å">
            </div>
            <button class="btn btn-primary" style="width:100%;" onclick="confirmStaff()">ç¢ºå®šé€²å…¥</button>
        </div>
    </div>

    <div id="court-selection-page" class="page">
        <div id="current-judge-tag" style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">ç›®å‰è£åˆ¤ï¼šæœªç™»éŒ„</div>
        <h2 style="margin-bottom: 30px;">é¸æ“‡åŸ·æ³•å ´åœ°</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; width:100%; max-width:450px; padding: 10px;">
            <button class="court-btn" onclick="selectCourt('1')">å ´åœ° 1</button>
            <button class="court-btn" onclick="selectCourt('2')">å ´åœ° 2</button>
            <button class="court-btn" onclick="selectCourt('3')">å ´åœ° 3</button>
            <button class="court-btn" onclick="selectCourt('4')">å ´åœ° 4</button>
            <button class="court-btn" onclick="selectCourt('5')">å ´åœ° 5</button>
            <button class="court-btn" onclick="selectCourt('6')">å ´åœ° 6</button>
        </div>
    </div>

    <div id="pre-game-page" class="page">
        <h2 id="setup-title">å ´åœ°è¨­å®š</h2>
        <div class="input-group" style="max-width:300px;">
            <label>éšŠä¼/é¸æ‰‹ A</label><input type="text" id="teamA-names" placeholder="éšŠä¼/é¸æ‰‹ A åç¨±">
            <br><br>
            <label>éšŠä¼/é¸æ‰‹ B</label><input type="text" id="teamB-names" placeholder="éšŠä¼/é¸æ‰‹ B åç¨±">
        </div>
        <button class="btn btn-primary" onclick="startMatch()">é–‹å§‹æ¯”è³½</button>
    </div>

    <div id="scoring-page" class="page">
        <div id="current-set-label" style="background:var(--accent); padding:5px 15px; border-radius:15px; font-weight:bold; margin-bottom:10px;">ç¬¬ 1 å±€</div>
        <div class="scoreboard">
            <div id="team-container" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div style="flex: 1; text-align: center;">
                    <div id="set-won-A" style="color: var(--secondary); font-size: 0.9rem;">Sets: 0</div>
                    <div id="dot-A" class="serving-dot serving-active"></div>
                    <div id="score-A" class="score-num" onclick="addScore('A')">0</div>
                    <div id="display-nameA" style="font-weight:bold">A éšŠ</div>
                </div>
                <div style="text-align: center; min-width: 100px;">
                    <div style="font-size: 1.5rem; color: #ccc; font-weight: bold;">VS</div>
                    <div id="status-note" class="deuce-alert">DEUCE</div>
                </div>
                <div style="flex: 1; text-align: center;">
                    <div id="set-won-B" style="color: var(--secondary); font-size: 0.9rem;">Sets: 0</div>
                    <div id="dot-B" class="serving-dot"></div>
                    <div id="score-B" class="score-num" onclick="addScore('B')">0</div>
                    <div id="display-nameB" style="font-weight:bold">B éšŠ</div>
                </div>
            </div>
        </div>
        <div style="font-size: 0.8rem; color:#888; margin-top:10px;">åŸ·æ³•è£åˆ¤ï¼š<span id="scoring-judge-name">-</span></div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; max-width: 500px; margin-top: 15px;">
            <button class="btn btn-outline" onclick="undo()">â†©ï¸ æ¢å¾©ä¸Šä¸€åˆ†</button>
            <button class="btn btn-outline" onclick="switchSide()">ğŸ”„ æ›é‚Š</button>
            <button class="btn btn-outline" onclick="manualServe()">ğŸ¸ ç™¼çƒæ¬Šè®Šæ›´</button>
            <button class="btn btn-secondary" onclick="resetMatch()">âš ï¸ é‡è¨­</button>
        </div>
    </div>

    <div id="player-hub-page" class="page">
        <h1>è³½äº‹è³‡è¨Šå¤§å»³</h1>
        <div class="admin-box" style="border:none; box-shadow:none;">
            <h3 id="announcement-text">ç›®å‰æš«ç„¡è³½ç¨‹å…¬å‘Š</h3>
            <img id="schedule-img-display" src="" alt="è³½ç¨‹åœ–">
        </div>
        <button class="btn btn-primary" onclick="alert('åŠŸèƒ½é–‹ç™¼ä¸­...')">å³æ™‚æ¯”åˆ†æ¸…å–®</button>
    </div>

    <div id="admin-master-page" class="page">
        <h1 style="color: var(--secondary);">ğŸ› ï¸ è³½äº‹ç®¡ç†å¾Œå°</h1>
        <div class="admin-box">
            <h4>1. å ´åœ°è¦å‰‡è¨­å®š</h4>
            <select id="admin-court-select" style="margin-bottom:10px;"><option value="1">å ´åœ° 1</option><option value="2">å ´åœ° 2</option><option value="3">å ´åœ° 3</option><option value="4">å ´åœ° 4</option><option value="5">å ´åœ° 5</option><option value="6">å ´åœ° 6</option></select>
            <label>ç›®æ¨™å‹åˆ†ï¼š</label>
            <select id="rule-score-target">
                <option value="11">11 åˆ†åˆ¶</option>
                <option value="15">15 åˆ†åˆ¶</option>
                <option value="21">21 åˆ†åˆ¶</option>
            </select>
            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="updateCourtRule()">å¥—ç”¨è¦å‰‡</button>
        </div>
        <div class="admin-box">
            <h4>2. è³½ç¨‹å…¬å‘Š</h4>
            <textarea id="admin-announcement" placeholder="å…¬å‘Šæ–‡å­—..."></textarea>
            <input type="text" id="admin-img-url" placeholder="è³½ç¨‹åœ–ç‰‡ç¶²å€..." style="margin-top:10px;">
            <div style="display: flex;">
                <button class="btn btn-primary" style="flex:1;" onclick="publishNotice()">ç™¼å¸ƒ</button>
                <button class="btn btn-secondary" style="flex:1;" onclick="deleteNotice()">åˆªé™¤</button>
            </div>
        </div>
        <button class="btn btn-outline" style="margin-top:20px;" onclick="showPage('home-page')">é€€å‡ºå¾Œå°</button>
    </div>

    <button id="global-back-btn" class="back-fab" onclick="smartBack()">ğŸ”™</button>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAbj5MjkqNMCUwIM5b2Mbyw1OeJ55uZvMw",
        authDomain: "badminton-scorer-9c881.firebaseapp.com",
        projectId: "badminton-scorer-9c881",
        storageBucket: "badminton-scorer-9c881.firebasestorage.app",
        messagingSenderId: "83500315105",
        appId: "1:83500315105:web:852112812e448efbb6e2a0",
        measurementId: "G-4Q0Z4QCFFY"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentCourt = null;
    let loggedJudge = ""; 

    window.showPage = (id) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
        document.getElementById(id).classList.add('active-page');
        document.getElementById('global-back-btn').style.display = (id === 'home-page') ? 'none' : 'flex';
    };

    window.smartBack = () => {
        const curr = document.querySelector('.active-page').id;
        if(curr === 'scoring-page') if(!confirm("é€€å‡ºè¨ˆåˆ†ï¼Ÿ")) return;
        if(curr === 'staff-select-page') showPage('staff-verify-page');
        else if(curr === 'court-selection-page') showPage('staff-select-page');
        else if(curr === 'pre-game-page' || curr === 'scoring-page') showPage('court-selection-page');
        else showPage('home-page');
    };

    window.verifyStaff = () => {
        if(document.getElementById('staff-pass').value === '1234') showPage('staff-select-page');
        else alert('å¯†ç¢¼éŒ¯èª¤');
    };

    document.getElementById('staff-name-list').addEventListener('change', (e) => {
        document.getElementById('manual-name-group').style.display = (e.target.value === 'å…¶ä»–') ? 'block' : 'none';
    });

    window.confirmStaff = () => {
        const selectValue = document.getElementById('staff-name-list').value;
        const manualName = document.getElementById('staff-name-manual').value;
        if (selectValue === 'å…¶ä»–' && manualName) loggedJudge = manualName;
        else if (selectValue && selectValue !== 'å…¶ä»–') loggedJudge = selectValue;
        else return alert("è«‹é¸æ“‡æˆ–è¼¸å…¥æ‚¨çš„å§“å");
        document.getElementById('current-judge-tag').innerText = `ç›®å‰è£åˆ¤ï¼š${loggedJudge}`;
        showPage('court-selection-page');
    };

    window.adminLogin = () => { if(prompt("ç®¡ç†å“¡å¯†ç¢¼") === '9999') showPage('admin-master-page'); };
    window.updateCourtRule = async () => {
        const id = document.getElementById('admin-court-select').value;
        const target = parseInt(document.getElementById('rule-score-target').value);
        await updateDoc(doc(db, "games", id), { targetScore: target });
        alert(`å ´åœ° ${id} è¦å‰‡å·²æ›´æ–°`);
    };
    window.publishNotice = async () => {
        const content = document.getElementById('admin-announcement').value;
        const imgUrl = document.getElementById('admin-img-url').value;
        await setDoc(doc(db, "config", "announcement"), { content, imgUrl });
        alert("ç™¼å¸ƒæˆåŠŸ");
    };
    window.deleteNotice = async () => {
        if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await setDoc(doc(db, "config", "announcement"), { content: "", imgUrl: "" });
    };

    onSnapshot(doc(db, "config", "announcement"), (snap) => {
        if(snap.exists()){
            const d = snap.data();
            document.getElementById('announcement-text').innerText = d.content || "æš«ç„¡å…¬å‘Š";
            const imgEl = document.getElementById('schedule-img-display');
            if(d.imgUrl) { imgEl.src = d.imgUrl; imgEl.style.display = 'block'; } else imgEl.style.display = 'none';
        }
    });

    window.selectCourt = (id) => { currentCourt = id; showPage('pre-game-page'); listenToCourt(id); };

    function listenToCourt(id) {
        onSnapshot(doc(db, "games", id), (snap) => {
            if (snap.exists()) {
                const data = snap.data();
                updateUI(data);
                if (data.isWaitingNext && document.getElementById('game-over-overlay').style.display !== 'flex') {
                    showWinnerOverlay(data.scoreA > data.scoreB ? data.nameA : data.nameB, data.scoreA, data.scoreB);
                }
            }
        });
    }

    function updateUI(data) {
        const sA = data.scoreA, sB = data.scoreB, target = data.targetScore || 21;
        // --- æ–°å¢é€™ä¸€è¡Œï¼šè®“è£åˆ¤åœ¨è¨­å®šåå­—æ™‚èƒ½çœ‹åˆ°ç¾åœ¨æ˜¯å¹¾åˆ†åˆ¶ ---
        document.getElementById('current-rule-display').innerText = `${target} åˆ†åˆ¶`;
        // ---------------------------------------------------
        document.getElementById('score-A').innerText = sA;
        document.getElementById('score-B').innerText = sB;
        document.getElementById('display-nameA').innerText = data.nameA;
        document.getElementById('display-nameB').innerText = data.nameB;
        document.getElementById('set-won-A').innerText = `Sets: ${data.setsA}`;
        document.getElementById('set-won-B').innerText = `Sets: ${data.setsB}`;
        document.getElementById('current-set-label').innerText = `ç¬¬ ${data.currentSet} å±€ (${target}åˆ†)`;
        document.getElementById('scoring-judge-name').innerText = data.judgeName || "æœªç™»éŒ„";
        
        document.getElementById('score-A').classList.toggle('game-point', sA >= target-1 && sA > sB);
        document.getElementById('score-B').classList.toggle('game-point', sB >= target-1 && sB > sA);
        document.getElementById('status-note').style.display = (sA >= target-1 && sB >= target-1 && sA === sB) ? 'block' : 'none';
        document.getElementById('dot-A').className = data.server === 'A' ? 'serving-dot serving-active' : 'serving-dot';
        document.getElementById('dot-B').className = data.server === 'B' ? 'serving-dot serving-active' : 'serving-dot';
    }

    window.startMatch = async () => {
        const docRef = doc(db, "games", currentCourt);
        const snap = await getDoc(docRef);
        const target = snap.exists() ? (snap.data().targetScore || 21) : 21;
        await setDoc(docRef, { scoreA: 0, scoreB: 0, setsA: 0, setsB: 0, nameA: document.getElementById('teamA-names').value || "A", nameB: document.getElementById('teamB-names').value || "B", currentSet: 1, server: 'A', history: [], isWaitingNext: false, targetScore: target, judgeName: loggedJudge });
        showPage('scoring-page');
    };

    window.addScore = async (team) => {
        const docRef = doc(db, "games", currentCourt);
        const d = (await getDoc(docRef)).data();
        const target = d.targetScore || 21;
        const nA = team === 'A' ? d.scoreA + 1 : d.scoreA, nB = team === 'B' ? d.scoreB + 1 : d.scoreB;
        const win = (nA >= target && nA-nB >= 2) || (nB >= target && nB-nA >= 2) || nA === target+9 || nB === target+9;
        const hist = d.history || []; hist.push({scoreA:d.scoreA, scoreB:d.scoreB, server:d.server});
        await updateDoc(docRef, { scoreA: nA, scoreB: nB, server: team, history: hist.slice(-10), isWaitingNext: win });
    };

    window.confirmNextSet = async () => {
        const docRef = doc(db, "games", currentCourt);
        const d = (await getDoc(docRef)).data();
        const winner = d.scoreA > d.scoreB ? 'A' : 'B';
        await updateDoc(docRef, { setsA: winner === 'A' ? d.setsA + 1 : d.setsA, setsB: winner === 'B' ? d.setsB + 1 : d.setsB, scoreA: 0, scoreB: 0, currentSet: d.currentSet+1, server: winner, isWaitingNext: false, history: [] });
        document.getElementById('game-over-overlay').style.display = 'none';
    };

    // ç²å‹å½ˆçª—æ›´æ–°ï¼šå‘ˆç¾æ¯”åˆ†èˆ‡å°æ‰‹å§“å
    function showWinnerOverlay(name, sA, sB) { 
        document.getElementById('winner-text').innerText = `${name} ç²å‹ï¼`; 
        document.getElementById('final-score-display').innerText = `${sA} : ${sB}`;
        document.getElementById('game-over-overlay').style.display = 'flex'; 
    }

    window.undo = async () => {
        const docRef = doc(db, "games", currentCourt);
        const d = (await getDoc(docRef)).data();
        if (d.history && d.history.length > 0) { const last = d.history.pop(); await updateDoc(docRef, { ...last, history: d.history, isWaitingNext: false }); }
        document.getElementById('game-over-overlay').style.display = 'none';
    };
    window.switchSide = () => { const c = document.getElementById('team-container'); c.style.flexDirection = c.style.flexDirection === 'row-reverse' ? 'row' : 'row-reverse'; };
    window.manualServe = async () => { const docRef = doc(db, "games", currentCourt); const s = (await getDoc(docRef)).data().server; await updateDoc(docRef, { server: s === 'A' ? 'B' : 'A' }); };
    window.resetMatch = async () => { if (confirm("é‡è¨­æ¯”è³½ï¼Ÿ")) startMatch(); };
</script>
</body>
</html>