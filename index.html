<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vic's Badminton Pro</title> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --primary: #2dd4bf;
            --secondary: #fb7185;
            --accent: #fbbf24;
            --text-main: #f8fafc;
        }
        
        body { 
            font-family: 'Inter', 'Segoe UI', 'Microsoft JhengHei', sans-serif; 
            background: radial-gradient(circle at top, #1e293b 0%, #0f172a 100%);
            color: var(--text-main); margin: 0; min-height: 100vh; overflow-x: hidden;
        }

        /* é é¢åˆ‡æ› */
        .page { display: none; min-height: 100vh; padding: 25px; box-sizing: border-box; flex-direction: column; align-items: center; }
        .active-page { display: flex !important; animation: fadeIn 0.4s ease-out; }

        /* é ‚ç´šç™¼å…‰æŒ‰éˆ• */
        .btn { 
            padding: 16px 32px; border-radius: 16px; border: none; font-size: 1rem; font-weight: 700; 
            cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            margin: 10px; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--primary); color: #0f172a; box-shadow: 0 0 20px rgba(45, 212, 191, 0.3); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-secondary { background: var(--secondary); color: white; box-shadow: 0 0 20px rgba(251, 113, 133, 0.3); }
        .btn-gray { background: rgba(255,255,255,0.1); color: white; backdrop-filter: blur(10px); }

        /* å ´åœ°å¡ç‰‡ - å¤§å»³å°ˆç”¨ */
        .hub-grid { display: grid; grid-template-columns: 1fr; gap: 15px; width: 100%; max-width: 500px; }
        .hub-card { 
            background: var(--card-bg); border-radius: 20px; padding: 20px; 
            border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(12px);
            display: flex; justify-content: space-between; align-items: center;
            transition: 0.3s;
        }
        .hub-card.active { border-left: 4px solid var(--primary); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .hub-card.idle { opacity: 0.4; border: 1px dashed rgba(255,255,255,0.2); }

        /* è¨ˆåˆ†æ¿è¨­è¨ˆ */
        .scoreboard { 
            width: 100%; max-width: 500px; background: var(--card-bg); 
            border-radius: 30px; padding: 30px; border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); text-align: center;
        }
        .score-num { font-size: 6.5rem; font-weight: 900; margin: 10px 0; cursor: pointer; color: var(--text-main); text-shadow: 0 0 30px rgba(255,255,255,0.1); }
        .set-score { font-size: 1.5rem; color: var(--accent); font-weight: bold; }

        /* å‘¼å¸ç‡ˆ */
        .serving-dot { width: 12px; height: 12px; background: var(--primary); border-radius: 50%; margin: 10px auto; visibility: hidden; }
        .serving-active { visibility: visible; animation: glow 1.5s infinite; }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 5px var(--primary); opacity: 1; } 50% { box-shadow: 0 0 20px var(--primary); opacity: 0.5; } }

        /* è¿”å›æŒ‰éˆ• */
        .back-fab { 
            position: fixed; right: 25px; bottom: 25px; width: 60px; height: 60px; 
            background: var(--secondary); color: white; border-radius: 50%; 
            display: none; justify-content: center; align-items: center; z-index: 1000;
            border: none; box-shadow: 0 10px 20px rgba(0,0,0,0.3); font-weight: bold;
        }

        /* å½ˆçª—ä¿®æ­£ */
        .overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(15, 23, 42, 0.95); display: none; 
            justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(10px);
        }

        /* ç®¡ç†å€åŸŸ */
        .admin-box { background: var(--card-bg); width: 100%; max-width: 450px; padding: 25px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); }
        input, select, textarea { 
            width: 100%; padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); 
            background: rgba(0,0,0,0.2); color: white; margin-top: 10px; font-size: 1rem;
        }
    </style>
</head>
<body>

    <div id="game-over-overlay" class="overlay">
        <div class="animate__animated animate__zoomIn text-center" style="text-align:center;">
            <h3 id="winner-text" style="color: var(--primary); font-size: 2rem;">WINNER!</h3>
            <div id="final-score-display" style="font-size: 5rem; font-weight: 900; margin: 20px 0;">21 : 19</div>
            <button class="btn btn-primary" style="margin: 0 auto;" onclick="confirmNextSet()">ä¸‹ä¸€å±€ / çµæŸæ¯”è³½</button>
        </div>
    </div>

    <div id="home-page" class="page active-page">
        <div id="home-logo-display" style="margin: 60px 0 30px;">
            <span style="font-size: 100px;">ğŸ¸</span>
        </div>
        <h1 style="font-size: 2.2rem; background: linear-gradient(to right, #2dd4bf, #fb7185); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800;">VIC BADMINTON</h1>
        <p style="opacity: 0.6; margin-bottom: 40px;">Professional Scoring System</p>
        
        <button class="btn btn-primary" style="width: 280px;" onclick="showPage('staff-verify-page')">è£åˆ¤æ¨¡å¼</button>
        <button class="btn btn-outline" style="width: 280px;" onclick="showPage('player-hub-page')">å³æ™‚è³½æ³</button>
        
        <div style="margin-top:auto; padding-bottom:30px; opacity: 0.4; font-size: 0.8rem; cursor: pointer;" onclick="adminLogin()">SYSTEM ADMIN</div>
    </div>

    <div id="staff-verify-page" class="page">
        <h2 style="margin-bottom: 30px;">èº«ä»½é©—è­‰</h2>
        <div class="admin-box">
            <input type="password" id="staff-pass" placeholder="è«‹è¼¸å…¥è£åˆ¤å¯†ç¢¼">
            <button class="btn btn-primary" style="width: 100%; margin: 20px 0 0;" onclick="verifyStaff()">ç™»å…¥ç³»çµ±</button>
        </div>
    </div>

    <div id="staff-select-page" class="page">
        <h2>é¸æ“‡è£åˆ¤å“¡</h2>
        <div class="admin-box">
            <select id="staff-name-list">
                <option value="Vic">Vic</option>
                <option value="Howard">Howard</option>
                <option value="å…¶ä»–">æ‰‹å‹•è¼¸å…¥...</option>
            </select>
            <input type="text" id="staff-name-manual" placeholder="è¼¸å…¥å§“å" style="display:none;">
            <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="confirmStaff()">é€²å…¥å ´åœ°é¸æ“‡</button>
        </div>
    </div>

    <div id="court-selection-page" class="page">
        <p id="current-judge-display" style="color: var(--primary); font-weight: bold;"></p>
        <h2>å ´åœ°åˆ†é…</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 450px;">
            <button class="btn btn-gray" style="height: 100px; margin:0;" id="court-btn-1" onclick="selectCourt('1')">å ´åœ° 1</button>
            <button class="btn btn-gray" style="height: 100px; margin:0;" id="court-btn-2" onclick="selectCourt('2')">å ´åœ° 2</button>
            <button class="btn btn-gray" style="height: 100px; margin:0;" id="court-btn-3" onclick="selectCourt('3')">å ´åœ° 3</button>
            <button class="btn btn-gray" style="height: 100px; margin:0;" id="court-btn-4" onclick="selectCourt('4')">å ´åœ° 4</button>
            <button class="btn btn-gray" style="height: 100px; margin:0;" id="court-btn-5" onclick="selectCourt('5')">å ´åœ° 5</button>
            <button class="btn btn-gray" style="height: 100px; margin:0;" id="court-btn-6" onclick="selectCourt('6')">å ´åœ° 6</button>
        </div>
    </div>

    <div id="pre-game-page" class="page">
        <h2 id="setup-court-label">å ´åœ°è¨­å®š</h2>
        <div class="admin-box">
            <label style="color:var(--primary)">Team A (Left Side)</label>
            <input type="text" id="teamA-names" placeholder="é¸æ‰‹ A1 / A2">
            <div style="text-align:center; margin: 15px 0; font-weight: bold; color: rgba(255,255,255,0.2);">V.S.</div>
            <label style="color:var(--secondary)">Team B (Right Side)</label>
            <input type="text" id="teamB-names" placeholder="é¸æ‰‹ B1 / B2">
            <button class="btn btn-primary" style="width: 100%; margin-top: 30px;" onclick="startMatch()">é–‹å§‹æ¯”è³½</button>
        </div>
    </div>

    <div id="scoring-page" class="page">
        <div id="current-set-label" style="color: var(--accent); margin-bottom: 15px; font-weight: 800; letter-spacing: 2px;">SET 1</div>
        <div class="scoreboard">
            <div style="display: flex; align-items: center; justify-content: space-around;">
                <div style="flex: 1;">
                    <div id="set-won-A" class="set-score">0</div>
                    <div id="dot-A" class="serving-dot"></div>
                    <div id="score-A" class="score-num" onclick="addScore('A')">0</div>
                    <div id="display-nameA" style="font-weight: 700; opacity: 0.8;">TEAM A</div>
                </div>
                <div style="font-size: 1.5rem; opacity: 0.2;">:</div>
                <div style="flex: 1;">
                    <div id="set-won-B" class="set-score">0</div>
                    <div id="dot-B" class="serving-dot"></div>
                    <div id="score-B" class="score-num" onclick="addScore('B')">0</div>
                    <div id="display-nameB" style="font-weight: 700; opacity: 0.8;">TEAM B</div>
                </div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 500px; margin-top: 25px;">
            <button class="btn btn-gray" onclick="undo()">UNDO æ¢å¾©</button>
            <button class="btn btn-gray" onclick="switchSide()">SWAP æ›é‚Š</button>
            <button class="btn btn-gray" onclick="manualServe()">SERVE ç™¼çƒ</button>
            <button class="btn btn-secondary" onclick="resetMatch()">RESET é‡è¨­</button>
        </div>
        <button class="btn btn-gray" style="width: 100%; max-width: 500px; border: 1px solid rgba(255,107,107,0.3);" onclick="clearCourtData()">EXIT çµæŸæœ¬å ´</button>
    </div>

    <div id="player-hub-page" class="page">
        <h2 style="margin-bottom: 5px;">LIVE SCORE</h2>
        <p id="announcement-text" style="opacity: 0.5; margin-bottom: 25px;">ç³»çµ±ç›£æ§ä¸­</p>
        <div class="hub-grid" id="live-scoreboard-grid"></div>
    </div>

    <div id="admin-master-page" class="page">
        <h2>ADMIN CONTROL</h2>
        <div class="admin-box">
            <input type="text" id="admin-home-img-url" placeholder="Logo URL">
            <textarea id="admin-announcement" placeholder="Announcement..."></textarea>
            <button class="btn btn-primary" style="width:100%" onclick="publishNotice()">SAVE SETTINGS</button>
            <hr style="opacity:0.1; margin: 20px 0;">
            <select id="rule-score-target">
                <option value="11">11 åˆ†åˆ¶</option>
                <option value="15">15 åˆ†åˆ¶</option>
                <option value="21" selected>21 åˆ†åˆ¶</option>
            </select>
            <button class="btn btn-secondary" style="width:100%" onclick="updateAllCourtsRule()">SYNC ALL COURTS</button>
        </div>
    </div>

    <button id="global-back-btn" class="back-fab" onclick="smartBack()">BACK</button>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAbj5MjkqNMCUwIM5b2Mbyw1OeJ55uZvMw",
        authDomain: "badminton-scorer-9c881.firebaseapp.com",
        projectId: "badminton-scorer-9c881",
        storageBucket: "badminton-scorer-9c881.firebasestorage.app",
        messagingSenderId: "83500315105",
        appId: "1:83500315105:web:852112812e448efbb6e2a0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentCourt = null;
    let loggedJudge = "";
    const courtList = ['1', '2', '3', '4', '5', '6'];

    // --- å°è¦½é‚è¼¯ ---
    window.showPage = (id) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
        document.getElementById(id).classList.add('active-page');
        document.getElementById('global-back-btn').style.display = (id === 'home-page') ? 'none' : 'flex';
        // åªæœ‰åœ¨é€²å…¥è¨ˆåˆ†é é¢ä¸”æœ‰è´å®¶æ™‚æ‰é¡¯ç¤ºå½ˆçª—
    };

    window.smartBack = () => showPage('home-page');
    window.verifyStaff = () => { if(document.getElementById('staff-pass').value === '1234') showPage('staff-select-page'); else alert('å¯†ç¢¼éŒ¯èª¤'); };
    window.adminLogin = () => { if(prompt("ADMIN PASS") === '9999') showPage('admin-master-page'); };

    document.getElementById('staff-name-list').onchange = (e) => {
        document.getElementById('staff-name-manual').style.display = (e.target.value === 'å…¶ä»–') ? 'block' : 'none';
    };

    window.confirmStaff = () => {
        const sel = document.getElementById('staff-name-list').value;
        loggedJudge = (sel === 'å…¶ä»–') ? document.getElementById('staff-name-manual').value : sel;
        if(!loggedJudge) return alert("è«‹è¼¸å…¥å§“å");
        document.getElementById('current-judge-display').innerText = `JUDGE: ${loggedJudge}`;
        showPage('court-selection-page');
    };

    // --- è¨ˆåˆ†é‚è¼¯ ---
    window.selectCourt = async (id) => {
        currentCourt = id;
        const snap = await getDoc(doc(db, "games", id));
        if(snap.exists() && snap.data().nameA !== "æº–å‚™ä¸­") {
            showPage('scoring-page');
        } else {
            document.getElementById('setup-court-label').innerText = `COURT ${id} SETUP`;
            showPage('pre-game-page');
        }
        listenToCourt(id);
    };

    window.startMatch = async () => {
        const snap = await getDoc(doc(db, "games", currentCourt));
        const t = snap.exists() ? (snap.data().targetScore || 21) : 21;
        await setDoc(doc(db, "games", currentCourt), { 
            scoreA: 0, scoreB: 0, setsA: 0, setsB: 0, 
            nameA: document.getElementById('teamA-names').value || "TEAM A", 
            nameB: document.getElementById('teamB-names').value || "TEAM B", 
            currentSet: 1, server: 'A', history: [], isWaitingNext: false, 
            targetScore: t, judgeName: loggedJudge 
        });
        showPage('scoring-page');
    };

    function listenToCourt(id) {
        onSnapshot(doc(db, "games", id), (snap) => {
            if (snap.exists() && currentCourt === id) {
                const d = snap.data();
                document.getElementById('score-A').innerText = d.scoreA;
                document.getElementById('score-B').innerText = d.scoreB;
                document.getElementById('display-nameA').innerText = d.nameA;
                document.getElementById('display-nameB').innerText = d.nameB;
                document.getElementById('set-won-A').innerText = d.setsA || 0;
                document.getElementById('set-won-B').innerText = d.setsB || 0;
                document.getElementById('current-set-label').innerText = `SET ${d.currentSet} (${d.targetScore || 21} PTS)`;
                document.getElementById('dot-A').className = d.server === 'A' ? 'serving-dot serving-active' : 'serving-dot';
                document.getElementById('dot-B').className = d.server === 'B' ? 'serving-dot serving-active' : 'serving-dot';
                
                const overlay = document.getElementById('game-over-overlay');
                if(d.isWaitingNext) {
                    document.getElementById('winner-text').innerText = `${d.scoreA > d.scoreB ? d.nameA : d.nameB} WIN!`;
                    document.getElementById('final-score-display').innerText = `${d.scoreA} : ${d.scoreB}`;
                    overlay.style.display = 'flex';
                } else {
                    overlay.style.display = 'none';
                }
            }
        });
    }

    window.addScore = async (team) => {
        const ref = doc(db, "games", currentCourt);
        const d = (await getDoc(ref)).data();
        const t = d.targetScore || 21;
        let nA = (team === 'A') ? d.scoreA + 1 : d.scoreA;
        let nB = (team === 'B') ? d.scoreB + 1 : d.scoreB;
        const win = (nA >= t && nA-nB >= 2) || (nB >= t && nB-nA >= 2) || nA === 30 || nB === 30;
        const h = d.history || []; h.push({scoreA: d.scoreA, scoreB: d.scoreB, server: d.server});
        await updateDoc(ref, { scoreA: nA, scoreB: nB, server: team, isWaitingNext: win, history: h.slice(-10) });
    };

    window.confirmNextSet = async () => {
        const ref = doc(db, "games", currentCourt);
        const d = (await getDoc(ref)).data();
        const winA = d.scoreA > d.scoreB;
        await updateDoc(ref, { 
            setsA: winA ? (d.setsA+1) : d.setsA, 
            setsB: !winA ? (d.setsB+1) : d.setsB, 
            scoreA: 0, scoreB: 0, currentSet: d.currentSet+1, isWaitingNext: false, history: [] 
        });
    };

    window.switchSide = async () => {
        const ref = doc(db, "games", currentCourt);
        const d = (await getDoc(ref)).data();
        await updateDoc(ref, { 
            nameA: d.nameB, nameB: d.nameA, 
            scoreA: d.scoreB, scoreB: d.scoreA, 
            setsA: d.setsB, setsB: d.setsA, server: d.server==='A'?'B':'A'
        });
    };

    window.undo = async () => {
        const ref = doc(db, "games", currentCourt);
        const d = (await getDoc(ref)).data();
        if(d.history && d.history.length > 0) {
            const last = d.history.pop();
            await updateDoc(ref, { ...last, history: d.history, isWaitingNext: false });
        }
    };

    window.clearCourtData = async () => {
        if(confirm("EXIT AND RESET COURT?")) {
            await setDoc(doc(db, "games", currentCourt), { nameA: "æº–å‚™ä¸­", nameB: "æº–å‚™ä¸­", scoreA: 0, scoreB: 0, setsA: 0, setsB: 0, currentSet: 1, judgeName: "", targetScore: 21 });
            showPage('court-selection-page');
        }
    };

    window.manualServe = async () => { const ref = doc(db, "games", currentCourt); const d = (await getDoc(ref)).data(); await updateDoc(ref, { server: d.server==='A'?'B':'A' }); };
    window.resetMatch = async () => { if(confirm("RESET SCORE?")) updateDoc(doc(db, "games", currentCourt), { scoreA: 0, scoreB: 0, history: [], isWaitingNext: false }); };

    // --- å¤§å»³åˆå§‹åŒ– ---
    const hubGrid = document.getElementById('live-scoreboard-grid');
    courtList.forEach(id => {
        const card = document.createElement('div');
        card.id = `hub-card-${id}`;
        card.className = 'hub-card idle';
        hubGrid.appendChild(card);
        
        onSnapshot(doc(db, "games", id), (snap) => {
            const d = snap.data();
            const cardEl = document.getElementById(`hub-card-${id}`);
            const courtBtn = document.getElementById(`court-btn-${id}`);
            if(d && d.nameA !== "æº–å‚™ä¸­") {
                cardEl.className = 'hub-card active';
                cardEl.innerHTML = `
                    <div style="flex:1">
                        <div style="font-size:0.7rem; color:var(--primary);">COURT ${id}</div>
                        <div style="font-weight:bold; font-size:1.1rem;">${d.nameA} vs ${d.nameB}</div>
                        <div style="font-size:0.6rem; opacity:0.5;">JUDGE: ${d.judgeName}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="color:var(--accent); font-weight:bold; font-size:0.8rem;">${d.setsA}:${d.setsB}</div>
                        <div style="font-size:1.8rem; font-weight:900; color:var(--primary);">${d.scoreA}:${d.scoreB}</div>
                    </div>
                `;
                if(courtBtn) { courtBtn.style.border = "2px solid var(--primary)"; courtBtn.style.color = "var(--primary)"; }
            } else {
                cardEl.className = 'hub-card idle';
                cardEl.innerHTML = `<div style="opacity:0.3">COURT ${id} - IDLE</div>`;
                if(courtBtn) { courtBtn.style.border = "none"; courtBtn.style.color = "white"; }
            }
        });
    });

    // --- å¾Œå°ç®¡ç†åŠŸèƒ½ ---
    window.publishNotice = async () => {
        await setDoc(doc(db, "config", "announcement"), { 
            content: document.getElementById('admin-announcement').value, 
            homeImg: document.getElementById('admin-home-img-url').value 
        });
        alert("UPDATED");
    };

    window.updateAllCourtsRule = async () => {
        const target = parseInt(document.getElementById('rule-score-target').value);
        const ps = courtList.map(id => updateDoc(doc(db, "games", id), { targetScore: target }));
        await Promise.all(ps);
        alert("SYNCED");
    };

    onSnapshot(doc(db, "config", "announcement"), (snap) => {
        if(snap.exists()){
            const d = snap.data();
            if(d.homeImg) document.getElementById('home-logo-display').innerHTML = `<img src="${d.homeImg}" style="max-width:150px; border-radius:20px;">`;
            document.getElementById('announcement-text').innerText = d.content || "SYSTEM MONITORING";
        }
    });

</script>
</body>
</html>
