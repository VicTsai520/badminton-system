<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vic's Badminton System</title> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { --bg-color: #f0f7f4; --primary: #4ecdc4; --secondary: #ff6b6b; --accent: #ffe66d; --text-main: #2f3e46; --card-bg: #ffffff; }
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; overflow-x: hidden; }
        
        /* é é¢åˆ‡æ›æ ¸å¿ƒ */
        .page { display: none; min-height: 100vh; padding: 20px; box-sizing: border-box; flex-direction: column; align-items: center; }
        .active-page { display: flex !important; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { 
            padding: 15px 25px; border-radius: 50px; border: none; font-size: 1rem; font-weight: bold; 
            cursor: pointer; transition: all 0.2s; margin: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            display: inline-block; text-decoration: none; text-align: center;
        }
        .btn-primary { background: linear-gradient(135deg, #4ecdc4 0%, #45b7af 100%); color: white; }
        .btn-outline { background: white; border: 2px solid var(--primary); color: var(--primary); }
        .btn-secondary { background: linear-gradient(135deg, #ff6b6b 0%, #ee5253 100%); color: white; }
        .btn-gray { background-color: #95a5a6; color: white; }

        /* å ´åœ°æŒ‰éˆ• */
        .court-btn { 
            padding: 25px; border-radius: 20px; border: 2px solid #eee; background: white; 
            font-size: 1.2rem; font-weight: bold; cursor: pointer; width: 100%; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        /* å³ä¸‹è§’è¿”å›æ–‡å­—æŒ‰éˆ• */
        .back-fab { 
            position: fixed; right: 20px; bottom: 20px; 
            width: 65px; height: 65px;  
            background: var(--secondary); color: white; 
            border-radius: 50%; display: none; 
            justify-content: center; align-items: center; 
            z-index: 999; border: none; 
            box-shadow: 0 4px 15px rgba(255,107,107,0.4); 
            font-size: 0.95rem; font-weight: bold; cursor: pointer;
        }
        
        /* è¨ˆåˆ†æ¿æ¨£å¼ */
        .scoreboard { width: 100%; max-width: 500px; background: white; border-radius: 25px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; }
        .score-num { font-size: 5.5rem; font-weight: 900; margin: 0; cursor: pointer; user-select: none; color: var(--text-main); line-height: 1; }
        .serving-dot { width: 14px; height: 14px; background: var(--secondary); border-radius: 50%; margin: 8px auto; visibility: hidden; }
        .serving-active { visibility: visible; }
        
        /* å½ˆçª— */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); display: none; justify-content: center; align-items: center; z-index: 1000; color: white; text-align: center; }
        .admin-box { background: white; width: 100%; max-width: 450px; padding: 25px; border-radius: 25px; margin-top: 15px; box-sizing: border-box; box-shadow: 0 10px 25px rgba(0,0,0,0.05); color: var(--text-main); }
        
        input, select, textarea { width: 100%; padding: 14px; border-radius: 12px; border: 2px solid #f0f0f0; box-sizing: border-box; font-size: 1rem; margin-top: 8px; }
        
        /* å¤§å»³å¡ç‰‡ */
        .hub-card { background: white; border-radius: 15px; padding: 15px; display: flex; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-left: 5px solid #4ecdc4; margin-bottom: 10px; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="game-over-overlay" class="overlay">
        <div class="animate__animated animate__zoomIn">
            <h2 id="winner-text" style="font-size: 2.8rem; color: var(--primary);">ç²å‹ï¼</h2>
            <div id="final-score-display" style="font-size: 4.5rem; font-weight: 900; margin-bottom: 25px;">0 : 0</div>
            <button class="btn btn-primary" style="width: 85%;" onclick="confirmNextSet()">ä¸‹ä¸€å±€ / çµæŸ</button>
        </div>
    </div>

    <div id="home-page" class="page active-page">
        <div id="home-logo-display" style="margin-top: 40px; min-height: 150px; display: flex; align-items: center; justify-content: center; width: 100%;">
            <span style="font-size: 80px;">ğŸ¸</span>
        </div>
        <h1 style="color: var(--primary); margin-bottom: 30px;">Vic è³½äº‹ç³»çµ±</h1>
        <button class="btn btn-primary" style="width: 250px;" onclick="showPage('staff-verify-page')">å·¥ä½œäººå“¡å…¥å£</button>
        <button class="btn btn-outline" style="width: 250px;" onclick="showPage('player-hub-page')">é¸æ‰‹/è§€çœ¾å¤§å»³</button>
        <div style="margin-top:auto; padding-bottom:40px; color:#95a5a6; cursor:pointer;" onclick="adminLogin()">âš™ï¸ å¾Œå°ç®¡ç†</div>
    </div>

    <div id="staff-verify-page" class="page">
        <h2>å·¥ä½œäººå“¡ç™»å…¥</h2>
        <input type="password" id="staff-pass" placeholder="è¼¸å…¥è£åˆ¤å¯†ç¢¼ (1234)" style="max-width:300px;">
        <button class="btn btn-primary" onclick="verifyStaff()">ä¸‹ä¸€æ­¥</button>
    </div>

    <div id="staff-select-page" class="page">
        <h2>åŸ·æ³•è£åˆ¤ç™»è¨˜</h2>
        <div class="admin-box">
            <select id="staff-name-list">
                <option value="">-- è«‹é¸æ“‡æ‚¨çš„å§“å --</option>
                <option value="Vic">Vic</option>
                <option value="Howard">Howard</option>
                <option value="å…¶ä»–">æ‰‹å‹•è¼¸å…¥...</option>
            </select>
            <input type="text" id="staff-name-manual" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„å§“å" style="display:none; margin-top:10px;">
            <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="confirmStaff()">ç¢ºå®šé€²å…¥</button>
        </div>
    </div>

    <div id="court-selection-page" class="page">
        <div id="current-judge-display" style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">è£åˆ¤ï¼šæœªç™»éŒ„</div>
        <h2 style="margin-bottom: 30px;">é¸æ“‡åŸ·æ³•å ´åœ°</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; width:100%; max-width:450px;">
            <button class="court-btn" onclick="selectCourt('1')">å ´åœ° 1</button>
            <button class="court-btn" onclick="selectCourt('2')">å ´åœ° 2</button>
            <button class="court-btn" onclick="selectCourt('3')">å ´åœ° 3</button>
            <button class="court-btn" onclick="selectCourt('4')">å ´åœ° 4</button>
            <button class="court-btn" onclick="selectCourt('5')">å ´åœ° 5</button>
            <button class="court-btn" onclick="selectCourt('6')">å ´åœ° 6</button>
        </div>
    </div>

    <div id="pre-game-page" class="page">
        <h2 id="setup-court-label">å ´åœ°è¨­å®š</h2>
        <div class="admin-box">
            <label>éšŠä¼ A</label>
            <input type="text" id="teamA-names" placeholder="è«‹è¼¸å…¥é¸æ‰‹åç¨±">
            <div style="text-align:center; margin:10px 0; font-weight:bold; opacity:0.5;">VS</div>
            <label>éšŠä¼ B</label>
            <input type="text" id="teamB-names" placeholder="è«‹è¼¸å…¥é¸æ‰‹åç¨±">
            <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="startMatch()">é–‹å§‹æ¯”è³½</button>
        </div>
    </div>

    <div id="scoring-page" class="page">
        <div id="current-set-label" style="background:var(--accent); padding:5px 15px; border-radius:15px; font-weight:bold; margin-bottom:10px;">ç¬¬ 1 å±€</div>
        <div class="scoreboard">
            <div id="team-layout" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                    <div id="set-won-A" style="font-weight:bold; color:var(--secondary);">Sets: 0</div>
                    <div id="dot-A" class="serving-dot"></div>
                    <div id="score-A" class="score-num" onclick="addScore('A')">0</div>
                    <div id="display-nameA" style="font-weight:bold; margin-top:10px;">A éšŠ</div>
                </div>
                <div style="width: 40px; font-weight:bold; opacity:0.3;">VS</div>
                <div style="flex: 1;">
                    <div id="set-won-B" style="font-weight:bold; color:var(--secondary);">Sets: 0</div>
                    <div id="dot-B" class="serving-dot"></div>
                    <div id="score-B" class="score-num" onclick="addScore('B')">0</div>
                    <div id="display-nameB" style="font-weight:bold; margin-top:10px;">B éšŠ</div>
                </div>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; max-width: 500px; margin-top: 20px;">
            <button class="btn btn-outline" onclick="undo()">â†©ï¸ æ¢å¾©</button>
            <button class="btn btn-outline" onclick="switchSide()">ğŸ”„ æ›é‚Š</button>
            <button class="btn btn-outline" onclick="manualServe()">ğŸ¸ ç™¼çƒ</button>
            <button class="btn btn-secondary" onclick="resetMatch()">âš ï¸ é‡è¨­</button>
        </div>
        <button class="btn btn-gray" style="width: 100%; max-width: 500px;" onclick="clearCourtData()">ğŸ”š çµæŸä¸¦æ¸…ç©ºå ´åœ°</button>
    </div>

    <div id="player-hub-page" class="page">
        <h1 style="color:var(--primary);">è³½äº‹è³‡è¨Šå¤§å»³</h1>
        <div class="admin-box" style="text-align:center; margin-bottom:20px;">
            <h3 id="announcement-text" style="margin:0;">è¼‰å…¥å…¬å‘Šä¸­...</h3>
            <img id="schedule-img-display" src="" style="max-width:100%; border-radius:10px; display:none; margin-top:15px;">
        </div>
        <div id="live-scoreboard-grid" style="width: 100%; max-width: 500px;">
            </div>
    </div>

    <div id="admin-master-page" class="page">
        <h2>ğŸ› ï¸ ç³»çµ±ç®¡ç†å¾Œå°</h2>
        <div class="admin-box">
            <h4>1. é¦–é åœ–ç‰‡èˆ‡å…¬å‘Š</h4>
            <label style="font-size:0.8rem;">é¦–é  Logo ç¶²å€</label>
            <input type="text" id="admin-home-img-url" placeholder="è²¼ä¸Šåœ–ç‰‡é€£çµ...">
            <label style="font-size:0.8rem;">å¤§å»³å…¬å‘Šå…§å®¹</label>
            <textarea id="admin-announcement" rows="2" placeholder="è¼¸å…¥å…¬å‘Šå…§å®¹..."></textarea>
            <label style="font-size:0.8rem;">å¤§å»³è³½ç¨‹åœ–ç¶²å€</label>
            <input type="text" id="admin-img-url" placeholder="è²¼ä¸Šè³½ç¨‹åœ–é€£çµ...">
            <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="publishNotice()">å„²å­˜ä¸¦ç™¼å¸ƒ</button>
            <hr>
            <h4>2. å…¨å ´è¦å‰‡</h4>
            <select id="rule-score-target">
                <option value="11">11 åˆ†åˆ¶</option>
                <option value="15">15 åˆ†åˆ¶</option>
                <option value="21" selected>21 åˆ†åˆ¶</option>
            </select>
            <button class="btn btn-secondary" style="width:100%; margin-top:10px;" onclick="updateAllCourtsRule()">å¥—ç”¨æ‰€æœ‰å ´åœ°</button>
        </div>
    </div>

    <button id="global-back-btn" class="back-fab" onclick="smartBack()">è¿”å›</button>

<script type="module">
    // Firebase åˆå§‹åŒ–
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAbj5MjkqNMCUwIM5b2Mbyw1OeJ55uZvMw",
        authDomain: "badminton-scorer-9c881.firebaseapp.com",
        projectId: "badminton-scorer-9c881",
        storageBucket: "badminton-scorer-9c881.firebasestorage.app",
        messagingSenderId: "83500315105",
        appId: "1:83500315105:web:852112812e448efbb6e2a0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    let currentCourt = null;
    let loggedJudge = "";
    const courtList = ['1', '2', '3', '4', '5', '6'];

    // --- é é¢è·³è½‰ ---
    window.showPage = (id) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
        const target = document.getElementById(id);
        if(target) target.classList.add('active-page');
        
        // é™¤äº†é¦–é ï¼Œå…¶ä»–é é¢éƒ½é¡¯ç¤ºè¿”å›æŒ‰éˆ•
        document.getElementById('global-back-btn').style.display = (id === 'home-page') ? 'none' : 'flex';
        window.scrollTo(0, 0);
    };

    window.smartBack = () => showPage('home-page');

    // --- è£åˆ¤ç™»å…¥ ---
    document.getElementById('staff-name-list').onchange = (e) => {
        document.getElementById('staff-name-manual').style.display = (e.target.value === 'å…¶ä»–') ? 'block' : 'none';
    };

    window.verifyStaff = () => {
        if(document.getElementById('staff-pass').value === '1234') showPage('staff-select-page');
        else alert('å¯†ç¢¼éŒ¯èª¤');
    };

    window.confirmStaff = () => {
        const sel = document.getElementById('staff-name-list').value;
        loggedJudge = (sel === 'å…¶ä»–') ? document.getElementById('staff-name-manual').value : sel;
        if(!loggedJudge) return alert("è«‹è¼¸å…¥å§“å");
        document.getElementById('current-judge-display').innerText = `è£åˆ¤ï¼š${loggedJudge}`;
        showPage('court-selection-page');
    };

    // --- å¾Œå°ç®¡ç†é‚è¼¯ ---
    window.adminLogin = () => { if(prompt("ç®¡ç†å“¡å¯†ç¢¼") === '9999') showPage('admin-master-page'); };

    window.publishNotice = async () => {
        await setDoc(doc(db, "config", "announcement"), { 
            content: document.getElementById('admin-announcement').value, 
            homeImg: document.getElementById('admin-home-img-url').value,
            imgUrl: document.getElementById('admin-img-url').value 
        });
        alert("è¨­å®šå·²åŒæ­¥æ›´æ–°");
    };

    // ç›£è½å¾Œå°è¨­å®šï¼ˆé¦–é åœ–ç‰‡ã€å¤§å»³åœ–ç‰‡ã€å…¬å‘Šï¼‰
    onSnapshot(doc(db, "config", "announcement"), (snap) => {
        if(snap.exists()){
            const d = snap.data();
            // 1. æ›´æ–°é¦–é  Logo
            const homeLogo = document.getElementById('home-logo-display');
            if(d.homeImg && d.homeImg.trim() !== "") {
                homeLogo.innerHTML = `<img src="${d.homeImg}" style="max-width:80%; max-height:180px; border-radius:15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">`;
            } else {
                homeLogo.innerHTML = `<span style="font-size: 80px;">ğŸ¸</span>`;
            }
            // 2. æ›´æ–°å¤§å»³å…¬å‘Š
            document.getElementById('announcement-text').innerText = d.content || "æ­¡è¿åƒåŠ æ¯”è³½";
            const img = document.getElementById('schedule-img-display');
            if(d.imgUrl) { img.src = d.imgUrl; img.style.display = 'block'; } else img.style.display = 'none';
            // 3. åå¡«å›å¾Œå°è¼¸å…¥æ¡†
            if(document.getElementById('admin-home-img-url')) {
                document.getElementById('admin-home-img-url').value = d.homeImg || "";
                document.getElementById('admin-announcement').value = d.content || "";
                document.getElementById('admin-img-url').value = d.imgUrl || "";
            }
        }
    });

    // --- æ¯”è³½æµç¨‹é‚è¼¯ ---
    window.selectCourt = async (id) => {
        currentCourt = id;
        document.getElementById('setup-court-label').innerText = `å ´åœ° ${id} è¨­å®š`;
        const snap = await getDoc(doc(db, "games", id));
        if(snap.exists() && snap.data().nameA !== "æº–å‚™ä¸­") {
            showPage('scoring-page');
        } else {
            showPage('pre-game-page');
        }
        listenToCourt(id);
    };

    window.startMatch = async () => {
        await setDoc(doc(db, "games", currentCourt), { 
            scoreA: 0, scoreB: 0, setsA: 0, setsB: 0, 
            nameA: document.getElementById('teamA-names').value || "A éšŠ", 
            nameB: document.getElementById('teamB-names').value || "B éšŠ", 
            currentSet: 1, server: 'A', history: [], isWaitingNext: false, 
            targetScore: 21, judgeName: loggedJudge, sideSwapped: false 
        });
        showPage('scoring-page');
    };

    function listenToCourt(id) {
        onSnapshot(doc(db, "games", id), (snap) => {
            if (snap.exists() && currentCourt === id) {
                const data = snap.data();
                document.getElementById('score-A').innerText = data.scoreA;
                document.getElementById('score-B').innerText = data.scoreB;
                document.getElementById('display-nameA').innerText = data.nameA;
                document.getElementById('display-nameB').innerText = data.nameB;
                document.getElementById('set-won-A').innerText = `Sets: ${data.setsA || 0}`;
                document.getElementById('set-won-B').innerText = `Sets: ${data.setsB || 0}`;
                document.getElementById('dot-A').className = data.server === 'A' ? 'serving-dot serving-active' : 'serving-dot';
                document.getElementById('dot-B').className = data.server === 'B' ? 'serving-dot serving-active' : 'serving-dot';
                
                if(data.isWaitingNext) {
                    document.getElementById('winner-text').innerText = `${data.scoreA > data.scoreB ? data.nameA : data.nameB} ç²å‹ï¼`;
                    document.getElementById('final-score-display').innerText = `${data.scoreA} : ${data.scoreB}`;
                    document.getElementById('game-over-overlay').style.display = 'flex';
                }
            }
        });
    }

    // --- è¨ˆåˆ†æ“ä½œ ---
    window.addScore = async (team) => {
        const docRef = doc(db, "games", currentCourt);
        const d = (await getDoc(docRef)).data();
        let nA = (team === 'A') ? d.scoreA + 1 : d.scoreA;
        let nB = (team === 'B') ? d.scoreB + 1 : d.scoreB;
        const target = d.targetScore || 21;
        const win = (nA >= target && nA-nB >= 2) || (nB >= target && nB-nA >= 2) || nA === 30 || nB === 30;
        
        const hist = d.history || [];
        hist.push({scoreA: d.scoreA, scoreB: d.scoreB, server: d.server});

        await updateDoc(docRef, { scoreA: nA, scoreB: nB, server: team, isWaitingNext: win, history: hist.slice(-5) });
    };

    window.undo = async () => {
        const docRef = doc(db, "games", currentCourt);
        const d = (await getDoc(docRef)).data();
        if(d.history && d.history.length > 0) {
            const last = d.history.pop();
            await updateDoc(docRef, { ...last, history: d.history, isWaitingNext: false });
            document.getElementById('game-over-overlay').style.display = 'none';
        }
    };

    window.confirmNextSet = async () => {
        const docRef = doc(db, "games", currentCourt);
        const d = (await getDoc(docRef)).data();
        const winA = d.scoreA > d.scoreB;
        await updateDoc(docRef, { 
            setsA: winA ? (d.setsA+1) : d.setsA, 
            setsB: !winA ? (d.setsB+1) : d.setsB, 
            scoreA: 0, scoreB: 0, currentSet: d.currentSet+1, isWaitingNext: false, history: [] 
        });
        document.getElementById('game-over-overlay').style.display = 'none';
    };

    window.clearCourtData = async () => {
        if(confirm("ç¢ºå®šçµæŸæ¯”è³½ä¸¦æ¸…ç©ºæ­¤å ´åœ°ï¼Ÿ")) {
            await setDoc(doc(db, "games", currentCourt), { nameA: "æº–å‚™ä¸­", nameB: "æº–å‚™ä¸­", scoreA: 0, scoreB: 0, setsA: 0, setsB: 0, currentSet: 1, judgeName: "" });
            showPage('court-selection-page');
        }
    };

    // --- å¤§å»³å³æ™‚å¡ç‰‡ç›£è½ ---
    courtList.forEach(id => {
        onSnapshot(doc(db, "games", id), (snap) => {
            const grid = document.getElementById('live-scoreboard-grid');
            let card = document.getElementById(`hub-card-${id}`);
            if(!card) {
                card = document.createElement('div');
                card.id = `hub-card-${id}`;
                card.className = 'hub-card';
                grid.appendChild(card);
            }
            if(snap.exists()){
                const d = snap.data();
                card.innerHTML = `
                    <div style="flex:1">
                        <div style="font-size:0.7rem; color:#888;">å ´åœ° ${id}</div>
                        <div style="font-weight:bold;">${d.nameA} vs ${d.nameB}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:1.2rem; font-weight:900; color:var(--primary);">${d.scoreA} : ${d.scoreB}</div>
                        <div style="font-size:0.7rem; background:#eee; padding:2px 5px; border-radius:4px;">Set ${d.currentSet || 1}</div>
                    </div>
                `;
                card.style.display = (d.nameA === "æº–å‚™ä¸­") ? "none" : "flex";
            }
        });
    });

</script>
</body>
</html>
