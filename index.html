<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vic's Badminton System Pro</title> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { --bg-color: #f0f7f4; --primary: #4ecdc4; --secondary: #ff6b6b; --accent: #ffe66d; --text-main: #2f3e46; --card-bg: #ffffff; }
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; overflow-x: hidden; }
        
        /* é é¢åˆ‡æ›æ ¸å¿ƒ */
        .page { display: none; min-height: 100vh; padding: 20px; box-sizing: border-box; flex-direction: column; align-items: center; }
        .active-page { display: flex !important; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { 
            padding: 16px 30px; 
            border-radius: 50px; 
            border: none; 
            font-size: 1.1rem; 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* åŠ å…¥å½ˆæ€§å‹•ç•« */
            margin: 10px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            display: inline-block; 
            text-decoration: none; 
            text-align: center;
            position: relative;
            top: 0;
        }
        /* æ‡¸åœæ•ˆæœï¼šå‘ä¸Šæµ®èµ·ã€é™°å½±åŠ æ·± */
        .btn:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 20px rgba(0,0,0,0.15); 
        }
        /* é»æ“Šç¬é–“æ•ˆæœï¼šå‘ä¸‹å‡¹é™·ã€ç¸®å° */
        .btn:active { transform: translateY(1px) scale(0.96); 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            transition: 0.1s;
        }
        .btn-primary { background: linear-gradient(135deg, #4ecdc4 0%, #3bb3ab 100%); 
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3); /* åŠ å…¥åŒè‰²ç³»é™°å½± */
        }

        .btn-primary:hover { 
            /* æ»‘é¼ ç§»éå»å¾Œï¼Œæ¼¸å±¤åè½‰ä¸¦åŠ æ·±ï¼Œç”¢ç”Ÿã€Œäº®èµ·ã€çš„æ„Ÿè¦º */
            background: linear-gradient(135deg, #3bb3ab 0%, #2d8d87 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.4);
        }
        /* 2. é¸æ‰‹/è§€çœ¾å¤§å»³ï¼šç¶­æŒå¤–æ¡†æ„Ÿä½†åŠ å¼· Hover */
        .btn-outline { background: white; 
            border: 2px solid #4ecdc4; 
            color: #3bb3ab; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .btn-outline:hover {
            background-color: #4ecdc4;
            color: white; /* ç§»éå»æ™‚å¡«æ»¿é¡è‰²ï¼Œå¢åŠ äº’å‹•é©šå–œ */
            transform: translateY(-3px);
        }
        .btn-secondary { background: linear-gradient(135deg, #ff6b6b 0%, #ee5253 100%); color: white; }
        .btn-gray { background-color: #95a5a6; color: white; }
        .btn-gray:hover {
            background-color: #7f8c8d; /* æ‡¸åœæ™‚ç¨å¾®è®Šæ·± */
        }

        /* åœ–ç‰‡æ”¾å¤§æª¢è¦–å™¨çš„é—œé–‰æŒ‰éˆ•äº’å‹• */
        #image-viewer span:hover {
        color: var(--secondary);
        transform: scale(1.2);
        transition: 0.2s;
        }

        /* LIVE ç´…é»å‘¼å¸ç‡ˆæ•ˆæœ */
        .live-dot {
            width: 12px;
            height: 12px;
            background-color: #ff6b6b; /* ç´…è‰² */
            border-radius: 50%;
            margin-right: 12px;
            /*position: relative;*/
            display: inline-block;
            /* å‘¼å¸å‹•ç•« */
            animation: live-breathe 1.5s infinite ease-in-out;
            /* åˆå§‹å…‰æšˆ */
            box-shadow: 0 0 8px rgba(255, 107, 107, 0.6);
        }

        @keyframes live-breathe {
            0% {
                transform: scale(1);
                opacity: 1;
                box-shadow: 0 0 0px rgba(255, 107, 107, 0.4);
            }
            50% {
                transform: scale(1.3);
                opacity: 0.7;
                box-shadow: 0 0 15px rgba(255, 107, 107, 0.9);
            }
            100% {
                transform: scale(1);
                opacity: 1;
                box-shadow: 0 0 0px rgba(255, 107, 107, 0.4);
            }
        }

        /* å ´åœ°æŒ‰éˆ• */
        .court-btn { 
            padding: 25px; 
            border-radius: 20px; 
            border: 2px solid #eee; 
            background: white; 
            font-size: 1.1rem; 
            font-weight: bold; 
            cursor: pointer; 
            width: 100%; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
            transition: all 0.3s ease;
        }
        .court-btn:hover {
            border-color: var(--primary);
            background-color: #f9fdfc;
            transform: scale(1.02);
        }

        .court-btn:active {
            background-color: #e0f2f1;
            transform: scale(0.98);
        }

        /* å³ä¸‹è§’è¿”å›æŒ‰éˆ• */
        .back-fab { 
            position: fixed; right: 20px; bottom: 20px; 
            width: 65px; height: 65px; background: var(--secondary); color: white; 
            border-radius: 50%; display: none; justify-content: center; align-items: center; 
            z-index: 999; border: none; box-shadow: 0 4px 15px rgba(255,107,107,0.4); 
            font-size: 0.95rem; font-weight: bold; cursor: pointer;
        }
        
        /* è¨ˆåˆ†æ¿èˆ‡å‘¼å¸ç‡ˆ */
        .scoreboard { width: 100%; max-width: 500px; background: white; border-radius: 25px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; }
        .score-num { font-size: 5.5rem; font-weight: 900; margin: 0; cursor: pointer; user-select: none; line-height: 1; transition: 0.1s; }
        
        .serving-dot { width: 16px; height: 16px; background: var(--secondary); border-radius: 50%; margin: 8px auto; visibility: hidden; box-shadow: 0 0 12px var(--secondary); }
        .serving-active { 
            visibility: visible !important; 
            animation: breathe 1.2s infinite ease-in-out; 
        }
        
        @keyframes breathe {
            0%, 100% { opacity: 1; transform: scale(1); box-shadow: 0 0 15px var(--secondary); }
            50% { opacity: 0.3; transform: scale(1.3); box-shadow: 0 0 5px var(--secondary); }
        }
        .deuce-text {
            color: #ff6b6b;
            font-weight: 900;
            font-size: 1.1rem;
            display: none; /* é è¨­éš±è— */
            position: absolute;
            /*transform: translateY(25px); /* è®“å®ƒé¡¯ç¤ºåœ¨ VS ä¸‹æ–¹ä¸€é» */
            top: 35px; /* æ”¹ç”¨ top å®šä½æ›´æº–ç¢º */
            white-space: nowrap; /* ç¢ºä¿æ–‡å­—ä¸æ›è¡Œ */
            text-shadow: 0 0 8px rgba(255,107,107,0.5);
            animation: deuceBreathe 1s infinite ease-in-out;
        }

        @keyframes deuceBreathe {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }

        /* å½ˆçª— */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                  background: rgba(0,0,0,0.92); display: none; justify-content: center;
                  align-items: center; z-index: 1000; color: white; text-align: center;
                  backdrop-filter: blur(5px); }
        
        .admin-box { background: white; width: 100%; max-width: 450px; padding: 25px; border-radius: 25px; margin-top: 15px; box-sizing: border-box; color: var(--text-main); text-align: left; }
        
        input, select, textarea { width: 100%; padding: 14px; border-radius: 12px; border: 2px solid #f0f0f0; box-sizing: border-box; font-size: 1rem; margin-top: 8px; }
        
        .hub-card { background: white; border-radius: 15px; padding: 15px; display: flex; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-left: 5px solid #4ecdc4; margin-bottom: 12px; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="game-over-overlay" class="overlay">
        <div class="animate__animated animate__zoomIn">
            <h2 id="winner-text" style="font-size: 2.8rem; color: var(--primary);">ç²å‹ï¼</h2>
            <div id="final-score-display" style="font-size: 4.5rem; font-weight: 900; margin-bottom: 25px;">0 : 0</div>
            <button class="btn btn-primary" style="width: 85%;" onclick="confirmNextSet()">ä¸‹ä¸€å±€ / çµæŸ</button>
        </div>
    </div>

    <div id="home-page" class="page active-page">
        <div id="home-logo-display" style="margin-top: 40px; min-height: 180px; display: flex; align-items: center; justify-content: center; width: 100%;">
            <span style="font-size: 80px;">ğŸ¸</span>
        </div>
        <h1 style="color: var(--primary); margin-bottom: 30px;">Vic è³½äº‹ç³»çµ±</h1>
        <button class="btn btn-primary" style="width: 250px;" onclick="showPage('staff-verify-page')">å·¥ä½œäººå“¡å…¥å£</button>
        <button class="btn btn-outline" style="width: 250px;" onclick="showPage('player-hub-page')">é¸æ‰‹/è§€çœ¾å¤§å»³</button>
        <div style="margin-top:auto; padding-bottom:40px; color:#95a5a6; cursor:pointer;" onclick="adminLogin()">âš™ï¸ å¾Œå°ç®¡ç†</div>
    </div>

    <div id="staff-verify-page" class="page">
        <h2>å·¥ä½œäººå“¡ç™»å…¥</h2>
        <input type="password" id="staff-pass" placeholder="è«‹è¼¸å…¥å·¥ä½œäººå“¡å¯†ç¢¼ (0000)" style="max-width:300px;">
        <button class="btn btn-primary" onclick="verifyStaff()">ä¸‹ä¸€æ­¥</button>
    </div>

    <div id="staff-select-page" class="page">
        <h2>è£åˆ¤ç™»è¨˜</h2>
        <div class="admin-box">
            <select id="staff-name-list">
                <option value="">-- è«‹é¸æ“‡æ‚¨çš„å§“å --</option>
                <option value="Vic">Vic</option>
                <option value="Howard">Howard</option> 
                <option value="å“æ·©">å“æ·©</option>
                <option value="Alice">Alice</option>
                <option value="å…¶ä»–">æ‰‹å‹•è¼¸å…¥...</option>
            </select>
            <input type="text" id="staff-name-manual" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„å§“å" style="display:none; margin-top:10px;">
            <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="confirmStaff()">ç¢ºå®šé€²å…¥</button>
        </div>
    </div>

    <div id="court-selection-page" class="page">
        <div id="current-judge-display" style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">è£åˆ¤ï¼šæœªç™»éŒ„</div>
        <h2 style="margin-bottom: 20px;">é¸æ“‡è¨ˆåˆ†å ´åœ°</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; width:100%; max-width:450px;">
            <button class="court-btn" id="court-btn-1" onclick="selectCourt('1')">å ´åœ° 1</button>
            <button class="court-btn" id="court-btn-2" onclick="selectCourt('2')">å ´åœ° 2</button>
            <button class="court-btn" id="court-btn-3" onclick="selectCourt('3')">å ´åœ° 3</button>
            <button class="court-btn" id="court-btn-4" onclick="selectCourt('4')">å ´åœ° 4</button>
            <button class="court-btn" id="court-btn-5" onclick="selectCourt('5')">å ´åœ° 5</button>
            <button class="court-btn" id="court-btn-6" onclick="selectCourt('6')">å ´åœ° 6</button>
        </div>
    </div>

    <div id="pre-game-page" class="page">
        <h2 id="setup-court-label">å ´åœ°è¨­å®š</h2>
        <div class="admin-box">
            <label>éšŠä¼ A</label><input type="text" id="teamA-names" placeholder="é¸æ‰‹åç¨±">
            <div style="text-align:center; margin:10px 0; font-weight:bold; opacity:0.5;">VS</div>
            <label>éšŠä¼ B</label><input type="text" id="teamB-names" placeholder="é¸æ‰‹åç¨±">
            <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="startMatch()">é–‹å§‹æ¯”è³½</button>
        </div>

        <!--å±€æ•¸è¨­å®š-->
        <div class="input-group">
            <label>æ¯”è³½å±€æ•¸</label>
            <select id="match-sets-select" class="btn" style="background: white; color: var(--text-main); width: 100%;">
                <option value="1">ä¸€å±€å®šå‹è²  (1å±€)</option>
                <option value="3" selected>ä¸‰æˆ°å…©å‹ (3å±€)</option>
            </select>
        </div>
    </div>

    <div id="scoring-page" class="page">
        <div id="current-set-label" style="background:var(--accent); padding:5px 15px; border-radius:15px; font-weight:bold; margin-bottom:10px;">ç¬¬ 1 å±€</div>
        <div class="scoreboard">
        <div style="display: flex; justify-content: space-between; align-items: center; position: relative; width: 100%;">
            <div style="flex: 1; text-align: center;">
                <div id="set-won-A" style="font-weight:bold; color:var(--secondary);">Sets: 0</div>
                <div id="dot-A" class="serving-dot"></div>
                <div id="score-A" class="score-num" onclick="addScore('A')">0</div>
                <div id="display-nameA" style="font-weight:bold; margin-top:10px; word-break: break-all;">A éšŠ</div>
            </div>

            <div style="width: 80px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; z-index: 10;">
                <div style="font-weight: 900; opacity: 0.8; font-size: 1.8rem; letter-spacing: 2px;">VS</div>
                <div id="deuce-indicator" class="deuce-text">DEUCE</div>
            </div>

            <div style="flex: 1; text-align: center;">
                <div id="set-won-B" style="font-weight:bold; color:var(--secondary);">Sets: 0</div>
                <div id="dot-B" class="serving-dot"></div>
                <div id="score-B" class="score-num" onclick="addScore('B')">0</div>
                <div id="display-nameB" style="font-weight:bold; margin-top:10px; word-break: break-all;">B éšŠ</div>
            </div>
            
        </div>
    </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; max-width: 500px; margin-top: 20px;">
            <button class="btn btn-outline" onclick="undo()">â†©ï¸ æ¢å¾©</button>
            <button class="btn btn-outline" onclick="switchSide()">ğŸ”„ æ›å ´</button>
            <button class="btn btn-outline" onclick="manualServe()">ğŸ¸ ç™¼çƒæ¬Šè®Šæ›´</button>
            <button class="btn btn-secondary" onclick="resetMatch()">âš ï¸ é‡è¨­</button>
        </div>
        <button class="btn btn-gray" style="width: 100%; max-width: 500px;" onclick="clearCourtData()">ğŸ”š çµæŸä¸¦æ¸…ç©ºå ´åœ°</button>
    </div>

    <div id="player-hub-page" class="page">
        <h1 style="color:var(--primary);">è³½äº‹è³‡è¨Šå¤§å»³</h1>

        <div class="admin-box" style="text-align:center; margin-bottom:20px;">
            <h3 id="announcement-text" style="margin:0;">è¼‰å…¥å…¬å‘Šä¸­...</h3>
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%;">
                <img id="schedule-img-display" src="" 
                     style="max-width: 90%; max-height: 400px; border-radius: 12px; display: none; cursor: zoom-in; margin-top: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <div id="zoom-hint" style="display:none; font-size: 0.8rem; color: #888; margin-top: 8px;">ğŸ” é»æ“Šåœ–ç‰‡å¯æ”¾å¤§æŸ¥çœ‹</div>
            </div>
            </div>

        <!--è³½äº‹liveç¤ºæ„-->
        <div style="display: flex; align-items: center; justify-content: center; width: 100%; max-width: 500px; margin: 20px auto 15px auto;">
                <span class="live-dot"></span>
                <h2 style="color: #4ecdc4; margin: 0; font-size: 1.2rem; letter-spacing: 1px; font-weight: bold;">LIVE å³æ™‚è³½æ³</h2>
        </div>
        
        <div id="live-scoreboard-grid" style="width: 100%; max-width: 500px;"></div>
    </div>

    <!-- å…¨è¢å¹•åœ–ç‰‡å½ˆçª— -->
    <div id="image-viewer" class="overlay" onclick="closeImageViewer()">
        <span style="position:absolute; top:20px; right:20px; font-size:30px; cursor:pointer;">âœ•</span>
        <img id="full-size-image" src="" style="max-width:95%; max-height:95%; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,0.5);">
    </div>

    <div id="admin-master-page" class="page">
        <h2>ğŸ› ï¸ ç®¡ç†å¾Œå°</h2>
        <div class="admin-box">
            <h4>1. é¦–é ã€å…¬å‘Šã€è³½ç¨‹åœ–</h4>
            <p style="font-size: 0.8rem; color: #888;">* ç•™ç©ºå‰‡è¡¨ç¤ºä¸è®Šæ›´è©²é …å…§å®¹</p>
            <input type="text" id="admin-home-img-url" placeholder="è®Šæ›´é¦–é  Logo åœ–ç‰‡ç¶²å€">
            <textarea id="admin-announcement" placeholder="è®Šæ›´å…¬å‘Šå…§å®¹"></textarea>
            <input type="text" id="admin-img-url" placeholder="è®Šæ›´å¤§å»³è³½ç¨‹åœ–ç¶²å€">
            <button class="btn btn-primary" style="width:100%;" onclick="publishNotice()">å„²å­˜ä¸¦ç™¼å¸ƒ</button>
            <hr>
            <h4>2. å…¨å ´åˆ†æ•¸è¦å‰‡</h4>
            <select id="rule-score-target">
                <option value="11" selected>11 åˆ†åˆ¶</option>
                <option value="15">15 åˆ†åˆ¶</option>
                <option value="21">21 åˆ†åˆ¶</option>
                <option value="25">25 åˆ†åˆ¶</option>
                <option value="31">31 åˆ†åˆ¶</option>
            </select>
            <button class="btn btn-secondary" style="width:100%;" onclick="updateAllCourtsRule()">å¥—ç”¨å…¨å ´</button>
        </div>
        <div class="admin-card animate__animated animate__fadeIn">
            <h3><i class="fas fa-cog"></i> å…¨åŸŸæ¯”è³½è¨­å®š</h3>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">çµ±ä¸€æ¯”è³½å±€æ•¸</label>
                <select id="admin-global-sets" class="btn" style="background: white; color: var(--text-main); width: 100%; border: 1px solid #ddd;">
                    <option value="1">ä¸€å±€å®šå‹è²  (1 å±€åˆ¶)</option>
                    <option value="3" selected>ä¸‰æˆ°å…©å‹ (3 å±€åˆ¶)</option>
                </select>
                <p style="font-size: 0.8rem; color: #666; margin-top: 8px;">â€» å„²å­˜å¾Œï¼Œå¾ŒçºŒæ–°é–‹å§‹çš„æ¯”è³½å°‡è‡ªå‹•å¥—ç”¨æ­¤è¨­å®šã€‚</p>
            </div>
            <button class="btn" onclick="saveGlobalSettings()" style="background: var(--primary); color: white; width: 100%;">å„²å­˜å…¨åŸŸè¨­å®š</button>
        </div>
    </div>

    <button id="global-back-btn" class="back-fab" onclick="smartBack()">è¿”å›</button>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAbj5MjkqNMCUwIM5b2Mbyw1OeJ55uZvMw",
        authDomain: "badminton-scorer-9c881.firebaseapp.com",
        projectId: "badminton-scorer-9c881",
        storageBucket: "badminton-scorer-9c881.firebasestorage.app",
        messagingSenderId: "83500315105",
        appId: "1:83500315105:web:852112812e448efbb6e2a0"
    };

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentCourt = null;
    let loggedJudge = "";
    const courtList = ['1', '2', '3', '4', '5', '6'];

    // --- é é¢æ ¸å¿ƒæ§åˆ¶ ---
    window.showPage = (id) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
        document.getElementById(id).classList.add('active-page');
        document.getElementById('global-back-btn').style.display = (id === 'home-page') ? 'none' : 'flex';
        window.scrollTo(0,0);
    };

    window.smartBack = () => showPage('home-page');

    // --- è£åˆ¤ç™»å…¥ ---
    window.verifyStaff = () => { 
        if(document.getElementById('staff-pass').value === '0000') showPage('staff-select-page'); 
        else alert('å¯†ç¢¼éŒ¯èª¤'); 
    };
    
    const staffSelect = document.getElementById('staff-name-list');
    if(staffSelect) {
        staffSelect.onchange = (e) => {
            document.getElementById('staff-name-manual').style.display = (e.target.value === 'å…¶ä»–') ? 'block' : 'none';
        };
    }

    window.confirmStaff = () => {
        const sel = document.getElementById('staff-name-list').value;
        loggedJudge = (sel === 'å…¶ä»–') ? document.getElementById('staff-name-manual').value : sel;
        if(!loggedJudge) return alert("è«‹è¼¸å…¥å§“å");
        document.getElementById('current-judge-display').innerText = `è£åˆ¤ï¼š${loggedJudge}`;
        showPage('court-selection-page');
    };

    // --- å¾Œå°åŠŸèƒ½ ---
    window.adminLogin = () => { if(prompt("ç®¡ç†å¯†ç¢¼") === '9999') showPage('admin-master-page'); };

    window.publishNotice = async () => {
        const homeImg = document.getElementById('admin-home-img-url').value;
        const announcement = document.getElementById('admin-announcement').value;
        const imgUrl = document.getElementById('admin-img-url').value;

        const updateData = {};
        
        // åªæœ‰ç•¶æ¬„ä½æœ‰å€¼æ™‚ï¼Œæ‰åŠ å…¥æ›´æ–°ç‰©ä»¶ä¸­
        if (homeImg) updateData.homeImg = homeImg;
        if (announcement) updateData.content = announcement;
        if (imgUrl) updateData.imgUrl = imgUrl;

        // å¦‚æœæ²’æœ‰å¡«å¯«ä»»ä½•æ±è¥¿ï¼Œå°±ä¸åŸ·è¡Œæ›´æ–°
        if (Object.keys(updateData).length === 0) {
            alert("è«‹è‡³å°‘è¼¸å…¥ä¸€é …è¦è®Šæ›´çš„å…§å®¹");
            return;
        }

        try {
            await updateDoc(doc(db, "config", "announcement"), updateData, { merge: true });
            alert("æ›´æ–°æˆåŠŸï¼æœªå¡«å¯«éƒ¨åˆ†å·²ç¶­æŒåŸæ¨£ã€‚");
            
            // æ›´æ–°å¾Œæ¸…ç©ºè¼¸å…¥æ¡†ï¼Œä¾¿ä¸‹æ¬¡ä½¿ç”¨
            document.getElementById('admin-home-img-url').value = "";
            document.getElementById('admin-announcement').value = "";
            document.getElementById('admin-img-url').value = "";
        } catch (e) {
            console.error("æ›´æ–°å¤±æ•—", e);
            alert("æ›´æ–°å¤±æ•—ï¼Œè«‹ç¢ºèªè³‡æ–™åº«æ¬Šé™");
        }
    };

    window.updateAllCourtsRule = async () => {
        const target = parseInt(document.getElementById('rule-score-target').value);
        if(!confirm(`ç¢ºå®šè¦å°‡å…¨å ´åœ°æ”¹ç‚º ${target} åˆ†åˆ¶å—ï¼Ÿ`)) return;
        const ps = courtList.map(id => updateDoc(doc(db, "games", id), { targetScore: target }));
        await Promise.all(ps);
        alert("è¦å‰‡åŒæ­¥æˆåŠŸ");
    };

    // ç›£è½å¾Œå°è¨­å®š
    onSnapshot(doc(db, "config", "announcement"), (snap) => {
        if(snap.exists()){
            const d = snap.data();
            const logo = document.getElementById('home-logo-display');
            logo.innerHTML = (d.homeImg) ? `<img src="${d.homeImg}" style="max-width:85%; max-height:180px; border-radius:20px; box-shadow:0 8px 20px rgba(0,0,0,0.1);">` : `<span style="font-size: 80px;">ğŸ¸</span>`;
            document.getElementById('announcement-text').innerText = d.content || "æ­¡è¿åƒåŠ æ¯”è³½";
            const sImg = document.getElementById('schedule-img-display');
            //åœ–ç‰‡æ›´æ–°
            if(d.imgUrl) { 
            sImg.src = d.imgUrl; 
            sImg.style.display = 'block';
            document.getElementById('zoom-hint').style.display = 'block'; // é¡¯ç¤ºæç¤º
            // é»æ“Šæ™‚æ‰“é–‹æ”¾å¤§å™¨
            sImg.onclick = () => window.openImageViewer(d.imgUrl);
            } else {
                sImg.style.display = 'none';
            }
        }
    });
    // æ§åˆ¶æ”¾å¤§å™¨çš„å‡½å¼
    window.openImageViewer = (url) => {
        document.getElementById('full-size-image').src = url;
        document.getElementById('image-viewer').style.display = 'flex';
    };

    window.closeImageViewer = () => {
        document.getElementById('image-viewer').style.display = 'none';
    };

    // --- è¨ˆåˆ†æ ¸å¿ƒï¼ˆå«é‡å…¥é‚è¼¯ï¼‰ ---
    window.selectCourt = async (id) => {
        currentCourt = id;
        try {
            const snap = await getDoc(doc(db, "games", id));
            if(snap.exists()){
                const d = snap.data();
                if(d.nameA !== "æº–å‚™ä¸­") {
                    showPage('scoring-page');
                } else {
                    document.getElementById('setup-court-label').innerText = `å ´åœ° ${id} è¨­å®š`;
                    showPage('pre-game-page');
                }
            } else {
                // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå…ˆè·³è¨­å®šé 
                document.getElementById('setup-court-label').innerText = `å ´åœ° ${id} è¨­å®š`;
                showPage('pre-game-page');
            }
            listenToCourt(id);
        } catch (e) {
            console.error("è®€å–å ´åœ°å¤±æ•—", e);
            alert("è³‡æ–™åº«é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™");
        }
    };
    // --- é–‹å§‹æ¯”è³½  ---
    window.startMatch = async () => {
        // 1. å–å¾— DOM å…ƒç´ 
        const inputA = document.getElementById('playerA-name');
        const inputB = document.getElementById('playerB-name');
        const targetSelect = document.getElementById('target-score-select');

        // 2. å–å¾—æ•¸å€¼ (åªåœ¨é€™é‚Šå®£å‘Šä¸€æ¬¡ targetScoreValue)
        const nA = (inputA && inputA.value) ? inputA.value : "A éšŠ";
        const nB = (inputB && inputB.value) ? inputB.value : "B éšŠ";
        const targetScoreValue = targetSelect ? parseInt(targetSelect.value) : 11;
        
        try {
            // å–å¾—è¨­å®šçš„ç¸½å±€æ•¸
            const configSnap = await getDoc(doc(db, "config", "match_settings"));
            const globalSets = configSnap.exists() ? configSnap.data().defaultTotalSets : 3; 

            await setDoc(doc(db, "games", currentCourt), {
                scoreA: 0, scoreB: 0, 
                setsA: 0, setsB: 0,
                nameA: nA, nameB: nB, 
                currentSet: 1, 
                totalSets: globalSets, // ä½¿ç”¨å¾Œå°è¨­å®šçš„å±€æ•¸
                server: 'A',
                history: [], 
                isWaitingNext: false, 
                targetScore: targetScoreValue, 
                judgeName: loggedJudge
            });

            // æˆåŠŸå¯«å…¥å¾Œæ‰è·³è½‰é é¢
            showPage('scoring-page');

        } catch (error) {
            console.error("å•Ÿå‹•æ¯”è³½å¤±æ•—:", error);
            alert("ç„¡æ³•å•Ÿå‹•æ¯”è³½ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–è³‡æ–™åº«æ¬Šé™");
        }
    };
    // --- ä¿®æ”¹ç›£è½é‚è¼¯ä»¥åŠ å…¥å±€é»è®Šç´…èˆ‡ Deuce æé†’ (å•é¡Œ3) ---
    function listenToCourt(id) {
        onSnapshot(doc(db, "games", id), (snap) => {
            if (snap.exists() && currentCourt === id) {
                const d = snap.data();
                const target = d.targetScore || 11;

                const sA = document.getElementById('score-A');
                const sB = document.getElementById('score-B');
                const label = document.getElementById('current-set-label');
                //å®šç¾©ä¸€æ¬¡DEUCE
                const deuceEl = document.getElementById('deuce-indicator'); // å–å¾— DEUCE å…ƒç´ 
                
                // æ›´æ–°åˆ†æ•¸èˆ‡éšŠä¼åç¨±èˆ‡å·²å‹å±€æ•¸ (è£œå›é€™å¹¾è¡Œ)
                sA.innerText = d.scoreA;
                sB.innerText = d.scoreB;

                document.getElementById('display-nameA').innerText = d.nameA;
                document.getElementById('display-nameB').innerText = d.nameB;
                document.getElementById('set-won-A').innerText = `Sets: ${d.setsA || 0}`;
                document.getElementById('set-won-B').innerText = `Sets: ${d.setsB || 0}`;
                
                // åˆ¤æ–· Game Point (å±€é») - åˆ†æ•¸è®Šç´…
                const isGamePointA = (d.scoreA >= target - 1 && d.scoreA > d.scoreB);
                const isGamePointB = (d.scoreB >= target - 1 && d.scoreB > d.scoreA);
                sA.style.color = isGamePointA ? 'var(--secondary)' : 'var(--text-main)';
                sB.style.color = isGamePointB ? 'var(--secondary)' : 'var(--text-main)';

                // åˆ¤æ–· Deuce (å¹³åˆ†)
                const isDeuce = (d.scoreA >= target - 1 && d.scoreA === d.scoreB);
                
                // æ›´æ–°æ¨™é¡Œï¼ˆç¶­æŒåŸæ¨£ï¼Œä¸éš¨ Deuce è®Šå‹•ï¼‰
                label.innerText = `ç¬¬ ${d.currentSet} å±€ (${target}åˆ†åˆ¶)`;
                label.style.background = 'var(--accent)';
                label.style.color = 'var(--text-main)';

                // æ§åˆ¶ DEUCE ç´…è‰²å‘¼å¸ç‡ˆé¡¯ç¤º
                if (deuceEl) {
                    deuceEl.style.display = isDeuce ? 'block' : 'none';
                }

                // å‘¼å¸ç‡ˆèˆ‡ç™¼çƒæ¬Š
                document.getElementById('dot-A').className = d.server === 'A' ? 'serving-dot serving-active' : 'serving-dot';
                document.getElementById('dot-B').className = d.server === 'B' ? 'serving-dot serving-active' : 'serving-dot';
                // ç²å‹å½ˆçª—
                if(d.isWaitingNext) {
                    document.getElementById('winner-text').innerText = `${d.scoreA > d.scoreB ? d.nameA : d.nameB} ç²å‹ï¼`;
                    document.getElementById('final-score-display').innerText = `${d.scoreA} : ${d.scoreB}`;
                    document.getElementById('game-over-overlay').style.display = 'flex';
                }
            }
        });
    }

    // è£œé½Š addScore, resetMatch ç­‰å…¶ä»–å‡½å¼çš„ window æ›è¼‰...
    window.addScore = async (team) => {
        const ref = doc(db, "games", currentCourt);
        const snap = await getDoc(ref);
        if (!snap.exists()) return;

        const d = snap.data();
        // é€™è£¡æœƒè®€å–è¨­å®šåˆ†æ•¸ 11, 15, 21, 25, 31 åˆ†
        const t = d.targetScore || 11;

        // è¨˜éŒ„ç•¶å‰ç‹€æ…‹åˆ° history
        const h = d.history || [];
        h.push({scoreA: d.scoreA, scoreB: d.scoreB, server: d.server}); // çµ±ä¸€ä½¿ç”¨ h

        let nA = (team === 'A') ? d.scoreA + 1 : d.scoreA;
        let nB = (team === 'B') ? d.scoreB + 1 : d.scoreB;
        // --- é€šç”¨åˆ¤å®šå…¬å¼ ---
        // æ¢ä»¶ 1ï¼šæœ‰äººé”åˆ°ç›®æ¨™åˆ†æ•¸ï¼Œä¸”é ˜å…ˆå°æ–¹è‡³å°‘ 2 åˆ† (ä¾‹å¦‚ 11:9, 21:19)
        // æ¢ä»¶ 2ï¼šå¦‚æœä¸€ç›´å¹³æ‰‹ï¼ˆDeuceï¼‰ï¼Œç›´åˆ°æœ‰äººå…ˆæ‹¿åˆ° 30 åˆ† (ç¾½çƒä¸Šé™è¦å‰‡)
        const win = (nA >= t && nA - nB >= 2) || (nB >= t && nB - nA >= 2) || nA === 30 || nB === 30;

        await updateDoc(ref, { 
            scoreA: nA, 
            scoreB: nB, 
            server: team, 
            isWaitingNext: win, 
            history: h // å‹™å¿…åŠ ä¸Šé€™ä¸€è¡Œ
        });
    };
    //é‡è¨­æŒ‰éˆ•
    window.resetMatch = async () => {
        if(confirm("ç¢ºå®šè¦é‡è¨­æœ¬å±€æ¯”åˆ†å—ï¼Ÿ(å°‡æ¸…ç©ºæ­·å²è¨˜éŒ„)")) {
            const ref = doc(db, "games", currentCourt);
            const d = (await getDoc(ref)).data();
            await updateDoc(ref, { 
                scoreA: 0, 
                scoreB: 0, 
                history: [], 
                isWaitingNext: false,
                server: 'A' 
            });
            alert("å·²é‡è¨­æ¯”åˆ†");
        }
    };

    // --- æ¢å¾©åŠŸèƒ½ (Undo) ---
    window.undo = async () => {
        const ref = doc(db, "games", currentCourt);
        const snap = await getDoc(ref);
        if (!snap.exists()) return;
        
        const d = snap.data();
        const h = d.history || [];
        
        if (h.length === 0) return alert("å·²ç¶“æ²’æœ‰æ›´æ—©çš„ç´€éŒ„äº†");
        
        // å–å¾—æœ€å¾Œä¸€ç­†æ­·å²ç´€éŒ„
        const lastState = h.pop();
        
        // æ›´æ–°å› Firebaseï¼Œä¸¦æŠŠå‰©ä¸‹çš„ history å­˜å›å»
        await updateDoc(ref, {
            scoreA: lastState.scoreA,
            scoreB: lastState.scoreB,
            server: lastState.server,
            isWaitingNext: false, 
            history: h // å‹™å¿…åŠ ä¸Šé€™ä¸€è¡Œï¼Œä»£è¡¨ç§»é™¤æœ€å¾Œä¸€ç­†å¾Œçš„ç´€éŒ„
        });
    };
    
    // --- ä¿®æ”¹æ¸…ç©ºå ´åœ°åŠŸèƒ½ä»¥ç¶­æŒåˆ†åˆ¶  ---
    window.clearCourtData = async () => {
        if(confirm("ç¢ºå®šæ¸…ç©ºå ´åœ°ï¼Ÿå°‡é‡è¨­æ‰€æœ‰æ¯”åˆ†èˆ‡è£åˆ¤åã€‚")) {
            const ref = doc(db, "games", currentCourt);
            const d = (await getDoc(ref)).data();
            const currentTarget = d.targetScore || 11; // è¨˜ä½ç›®å‰çš„åˆ†åˆ¶
            
            await setDoc(ref, { 
                nameA: "æº–å‚™ä¸­", 
                nameB: "æº–å‚™ä¸­", 
                scoreA: 0, 
                scoreB: 0, 
                setsA: 0, 
                setsB: 0, 
                currentSet: 1, 
                judgeName: "", 
                targetScore: currentTarget, // å¸¶å›åŸæœ¬çš„åˆ†åˆ¶
                history: [],
                isWaitingNext: false,
                server: 'A'
            });
            showPage('court-selection-page');
        }
    };
    window.confirmNextSet = async () => {
        const ref = doc(db, "games", currentCourt);
        const snap = await getDoc(ref);
        const d = snap.data();
        
        // 1. åˆ¤å®šé€™ä¸€å±€èª°è´äº†ï¼Œä¸¦è¨ˆç®—æ–°çš„å±€æ•¸æ¯”åˆ†
        let newSetsA = d.setsA || 0;
        let newSetsB = d.setsB || 0;
        if (d.scoreA > d.scoreB) {
            newSetsA++;
        } else {
            newSetsB++;
        }

        // å–å¾—è©²å ´åœ°å•Ÿå‹•æ™‚å¸¶å…¥çš„ç¸½å±€æ•¸è¨­å®š
        const totalSets = d.totalSets || 3;
        const winThreshold = Math.ceil(totalSets / 2); // 1å±€éœ€1å‹, 3å±€éœ€2å‹
        
        // 3. åˆ¤æ–·æ˜¯å¦å·²ç¶“é”æˆå‹å±€é–€æª» (æ¯”è³½æœ€çµ‚çµæŸ)
        if (newSetsA >= winThreshold || newSetsB >= winThreshold) {
            alert(`æ¯”è³½çµæŸï¼æ­å–œ ${newSetsA >= winThreshold ? d.nameA : d.nameB} ç²å‹ï¼`);
            
            // æ¯”è³½çµæŸï¼Œç›´æ¥åŸ·è¡Œæ¸…ç©ºå ´åœ°çš„å‹•ä½œ
            await window.clearCourtData(true); // å‚³å…¥ true ä»£è¡¨ä¸éœ€å†æ¬¡å½ˆå‡º confirm
            return;
        }

        // 4. è‹¥å°šæœªé”åˆ°å‹å±€é–€æª»ï¼Œå‰‡é€²å…¥ä¸‹ä¸€å±€ï¼Œé‡è¨­åˆ†æ•¸
        await updateDoc(ref, { 
            setsA: newSetsA, 
            setsB: newSetsB, 
            scoreA: 0, 
            scoreB: 0, 
            currentSet: (d.currentSet || 1) + 1, 
            isWaitingNext: false, 
            history: [] 
        });
        
        // éš±è—ç²å‹ç‡ˆç®±
        document.getElementById('game-over-overlay').style.display = 'none';
    };


    window.clearCourtData = async (auto = false) => {
        // å¦‚æœä¸æ˜¯è‡ªå‹•è§¸ç™¼çš„ï¼Œå°±å½ˆå‡ºç¢ºèªè¦–çª—
        if(auto || confirm("ç¢ºå®šæ¸…ç©ºå ´åœ°ï¼Ÿå°‡é‡è¨­æ‰€æœ‰æ¯”åˆ†èˆ‡è£åˆ¤åã€‚")) {
            const ref = doc(db, "games", currentCourt);
            const snap = await getDoc(ref);
            const d = snap.data();
            const currentTarget = d.targetScore || 11; 
            
            await setDoc(ref, { 
                nameA: "æº–å‚™ä¸­", 
                nameB: "æº–å‚™ä¸­", 
                scoreA: 0, 
                scoreB: 0, 
                setsA: 0, 
                setsB: 0, 
                currentSet: 1, 
                judgeName: "", 
                targetScore: currentTarget, 
                totalSets: d.totalSets || 3, // ä¿æŒåŸæœ¬çš„å±€æ•¸è¨­å®š
                history: [],
                isWaitingNext: false,
                server: 'A'
            });
            showPage('court-selection-page');
            // ç¢ºä¿ç‡ˆç®±é—œé–‰
            document.getElementById('game-over-overlay').style.display = 'none';
        }
    };

    window.manualServe = async () => { const ref = doc(db, "games", currentCourt); const d = (await getDoc(ref)).data(); await updateDoc(ref, { server: d.server==='A'?'B':'A' }); };
    window.switchSide = async () => {
        const ref = doc(db, "games", currentCourt);
        const d = (await getDoc(ref)).data();
        await updateDoc(ref, { nameA: d.nameB, nameB: d.nameA, scoreA: d.scoreB, scoreB: d.scoreA, setsA: d.setsB, setsB: d.setsA, server: d.server==='A'?'B':'A' });
    };

    window.saveGlobalSettings = async () => {
        const sets = parseInt(document.getElementById('admin-global-sets').value);
        try {
            // å°‡è¨­å®šå­˜å…¥ config é›†åˆä¸­çš„ match_settings æ–‡ä»¶
            await setDoc(doc(db, "config", "match_settings"), {
                defaultTotalSets: sets
            }, { merge: true });
            alert("âœ… å…¨åŸŸè¨­å®šå·²æ›´æ–°ï¼");
        } catch (e) {
            console.error(e);
            alert("âŒ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™");
        }
    };

    // --- å¤§å»³èˆ‡å ´åœ°ç‹€æ…‹ç›£è½ ---
    courtList.forEach(id => {
        onSnapshot(doc(db, "games", id), (snap) => {
            const grid = document.getElementById('live-scoreboard-grid');
            let card = document.getElementById(`hub-card-${id}`);

            if(!card) { 
                card = document.createElement('div'); 
                card.id = `hub-card-${id}`; 
                card.className = 'hub-card'; 
                grid.appendChild(card); 
            }

            if(snap.exists()){
                const d = snap.data();
                const isReady = (d.nameA === "æº–å‚™ä¸­");
                const target = d.targetScore || 11;

                // 1. åˆ¤æ–·æ˜¯å¦æ¥è¿‘çµæŸ (ä»»ä¸€æ–¹é”åˆ°å±€é»æ¸› 1 æ™‚è®Šç´…)
                // ä¾‹å¦‚ 11 åˆ†åˆ¶ï¼Œ10 åˆ†å°±è®Šç´…ï¼›21 åˆ†åˆ¶ï¼Œ20 åˆ†å°±è®Šç´…
                const isClosingIn = (d.scoreA >= target - 1 || d.scoreB >= target - 1);
                const scoreColor = isClosingIn ? 'var(--secondary)' : 'var(--primary)';
                
                // 2. æº–å‚™å±€æ•¸æ¯”åˆ†æ–‡å­— (Sets Score)
                const setsScoreText = `${d.setsA || 0} : ${d.setsB || 0}`;

                // ä¿®æ”¹å¾Œçš„é¡¯ç¤ºé‚è¼¯ï¼šå³ä½¿æ˜¯æº–å‚™ä¸­ä¹Ÿé¡¯ç¤ºï¼Œä¸¦èª¿æ•´æ¨£å¼å€åˆ†
                card.innerHTML = `
                    <div style="flex:1">
                        <div style="font-size:0.75rem; color:#888; margin-bottom: 2px;">å ´åœ° ${id}</div>
                        <div style="font-weight:bold; font-size:1.1rem; color:${isReady ? '#95a5a6' : 'var(--text-main)'};">
                            ${d.nameA} ${isReady ? '' : 'vs ' + d.nameB}
                        </div>
                        <div style="font-size:0.75rem; color:#666; margin-top:4px;">
                            ${isReady ? 'ç­‰å¾…é–‹è³½' : 'è£åˆ¤: ' + (d.judgeName || 'ç„¡')}
                        </div>
                    </div>
                    <div style="text-align:right; min-width:90px; display: flex; flex-direction: column; align-items: flex-end;">
                        <div style="font-size:1.9rem; font-weight:900; color:${scoreColor}; line-height:1;">
                            ${d.scoreA}:${d.scoreB}
                        </div>
                        
                        <div style="font-size:0.75rem; 
                                    background: #2f3e46; 
                                    color: white; 
                                    padding: 3px 10px; 
                                    border-radius: 6px; 
                                    display: inline-block; 
                                    margin-top: 8px; 
                                    font-weight: bold;
                                    letter-spacing: 0.5px;
                                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            ${isReady ? 'READY' : 'SETS ' + setsScoreText}
                        </div>
                    </div>`;
                
                // ç§»é™¤äº†åŸæœ‰çš„ card.style.display = "none" é‚è¼¯ï¼Œç¢ºä¿ 6 å€‹å ´åœ°çš†é¡¯ç¤º
                card.style.display = "flex"; 
                card.style.opacity = isReady ? "0.7" : "1"; // æº–å‚™ä¸­çš„å ´åœ°ç•¥å¾®é€æ˜ä»¥ç¤ºå€åˆ¥
                // åŒæ­¥å ´åœ°é¸æ“‡æŒ‰éˆ•é¡è‰²
                const btn = document.getElementById(`court-btn-${id}`);
                if(btn) {
                    if(d.nameA !== "æº–å‚™ä¸­") {
                        btn.style.borderColor = "var(--secondary)";
                        btn.innerHTML = `å ´åœ° ${id}<br><span style="font-size:0.7rem; color:var(--secondary);">æ¯”è³½ä¸­: ${d.judgeName}</span>`;
                    } else {
                        btn.style.borderColor = "#eee"; btn.innerHTML = `å ´åœ° ${id}`;
                    }
                }
            }
        });
    });
    
</script>
</body>
</html>
