<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vic's Badminton System Pro</title> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { --bg-color: #f0f7f4; --primary: #4ecdc4; --secondary: #ff6b6b; --accent: #ffe66d; --text-main: #2f3e46; --card-bg: #ffffff; }
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; overflow-x: hidden; }
        /*é é¢åˆ‡æ›æ ¸å¿ƒ*/
        .page { display: none; min-height: 100vh; padding: 20px; box-sizing: border-box; flex-direction: column; align-items: center; }
        .active-page { display: flex !important; }
        /*æŒ‰éˆ•æ¨£å¼*/
        .btn { padding: 16px 30px; border-radius: 50px; border: none; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); margin: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: inline-block; text-decoration: none; text-align: center; position: relative; top: 0; }
        /* æ‡¸åœæ•ˆæœï¼šå‘ä¸Šæµ®èµ·ã€é™°å½±åŠ æ·± */
        .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        /* é»æ“Šç¬é–“æ•ˆæœï¼šå‘ä¸‹å‡¹é™·ã€ç¸®å° */
        .btn:active { transform: translateY(1px) scale(0.96); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.1s; }
        .btn-primary { background: linear-gradient(135deg, #4ecdc4 0%, #3bb3ab 100%); color: white; box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3); }
        /* æ»‘é¼ ç§»éå»å¾Œï¼Œæ¼¸å±¤åè½‰ä¸¦åŠ æ·±ï¼Œç”¢ç”Ÿã€Œäº®èµ·ã€çš„æ„Ÿè¦º */
        .btn-primary:hover { background: linear-gradient(135deg, #3bb3ab 0%, #2d8d87 100%); transform: translateY(-3px); box-shadow: 0 8px 20px rgba(78, 205, 196, 0.4); }
        /* 2. é¸æ‰‹/è§€çœ¾å¤§å»³ï¼šç¶­æŒå¤–æ¡†æ„Ÿä½†åŠ å¼· Hover */
        .btn-outline { background: white; border: 2px solid #4ecdc4; color: #3bb3ab; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        /* ç§»éå»æ™‚å¡«æ»¿é¡è‰²ï¼Œå¢åŠ äº’å‹•é©šå–œ */
        .btn-outline:hover { background-color: #4ecdc4; color: white; }
        .btn-secondary { background: linear-gradient(135deg, #ff6b6b 0%, #ee5253 100%); color: white; }
        .btn-gray { background-color: #95a5a6; color: white; }
        /* æ‡¸åœæ™‚ç¨å¾®è®Šæ·± */
        .btn-gray:hover { background-color: #7f8c8d; }
        /* åœ–ç‰‡æ”¾å¤§æª¢è¦–å™¨çš„é—œé–‰æŒ‰éˆ•äº’å‹• */
        #image-viewer span:hover { color: var(--secondary); transform: scale(1.2); transition: 0.2s; }
        .live-dot { width: 12px; height: 12px; background-color: #ff6b6b; border-radius: 50%; margin-right: 12px; display: inline-block; animation: live-breathe 1.5s infinite ease-in-out; box-shadow: 0 0 8px rgba(255, 107, 107, 0.6); }
        @keyframes live-breathe { 0% {transform: scale(1); opacity: 1; box-shadow: 0 0 0px rgba(255, 107, 107, 0.4); } 50% { transform: scale(1.3); opacity: 0.7; box-shadow: 0 0 15px rgba(255, 107, 107, 0.9); } 100% { transform: scale(1); opacity: 1; box-shadow: 0 0 0px rgba(255, 107, 107, 0.4); } }
        .court-btn { padding: 25px; border-radius: 20px; border: 2px solid #eee; background: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; width: 100%; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: all 0.3s ease; }
        .court-btn:hover { border-color: var(--primary); transform: scale(1.02); }
        .back-fab { position: fixed; right: 20px; bottom: 20px; width: 65px; height: 65px; background: var(--secondary); color: white; border-radius: 50%; display: none; justify-content: center; align-items: center; z-index: 999; border: none; box-shadow: 0 4px 15px rgba(255,107,107,0.4); font-size: 0.95rem; font-weight: bold; cursor: pointer; }
        .scoreboard { width: 100%; max-width: 500px; background: white; border-radius: 25px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; }
        .score-num { font-size: 5.5rem; font-weight: 900; margin: 0; cursor: pointer; user-select: none; line-height: 1; transition: 0.1s; }
        .serving-dot { width: 16px; height: 16px; background: var(--secondary); border-radius: 50%; margin: 8px auto; visibility: hidden; }
        .serving-active { visibility: visible !important; animation: breathe 1.2s infinite ease-in-out; }
        @keyframes breathe { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.3; transform: scale(1.3); } }
        .deuce-text { color: #ff6b6b; font-weight: 900; font-size: 1.1rem; display: none; position: absolute; top: 35px; white-space: nowrap; animation: deuceBreathe 1s infinite ease-in-out; }
        @keyframes deuceBreathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); display: none; justify-content: center; align-items: center; z-index: 1000; color: white; text-align: center; backdrop-filter: blur(5px); }
        .admin-box { background: white; width: 100%; max-width: 450px; padding: 25px; border-radius: 25px; margin-top: 15px; box-sizing: border-box; color: var(--text-main); text-align: left; }
        input, select, textarea { width: 100%; padding: 14px; border-radius: 12px; border: 2px solid #f0f0f0; box-sizing: border-box; font-size: 1rem; margin-top: 8px; }
        .hub-card { background: white; border-radius: 15px; padding: 15px; display: flex; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-left: 5px solid #4ecdc4; margin-bottom: 12px; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="game-over-overlay" class="overlay">
        <div class="animate__animated animate__zoomIn">
            <h2 id="winner-text" style="font-size: 2.8rem; color: var(--primary);">ç²å‹ï¼</h2>
            <div id="final-score-display" style="font-size: 4.5rem; font-weight: 900; margin-bottom: 25px;">0 : 0</div>
            <button class="btn btn-primary" style="width: 85%;" onclick="confirmNextSet()">ä¸‹ä¸€å±€ / çµæŸ</button>
        </div>
    </div>

    <div id="home-page" class="page active-page">
        <div id="home-logo-display" style="margin-top: 40px; min-height: 180px; display: flex; align-items: center; justify-content: center; width: 100%;">
            <span style="font-size: 80px;">ğŸ¸</span>
        </div>
        <h1 style="color: var(--primary); margin-bottom: 30px;">Vic è³½äº‹ç³»çµ±</h1>
        <button class="btn btn-primary" style="width: 250px;" onclick="showPage('staff-verify-page')">å·¥ä½œäººå“¡å…¥å£</button>
        <button class="btn btn-outline" style="width: 250px;" onclick="showPage('player-hub-page')">é¸æ‰‹/è§€çœ¾å¤§å»³</button>
        <div style="margin-top:auto; padding-bottom:40px; color:#95a5a6; cursor:pointer;" onclick="adminLogin()">âš™ï¸ å¾Œå°ç®¡ç†</div>
    </div>

    <div id="staff-verify-page" class="page">
        <h2>å·¥ä½œäººå“¡ç™»å…¥</h2>
        <input type="password" id="staff-pass" placeholder="è«‹è¼¸å…¥å·¥ä½œäººå“¡å¯†ç¢¼ (0000)" style="max-width:300px;">
        <button class="btn btn-primary" onclick="verifyStaff()">ä¸‹ä¸€æ­¥</button>
    </div>

    <div id="staff-select-page" class="page">
        <h2>è£åˆ¤ç™»è¨˜</h2>
        <div class="admin-box">
            <select id="staff-name-list" onchange="checkManualName('staff')">
                <option value="">-- è«‹é¸æ“‡æ‚¨çš„å§“å --</option>
                <option value="Vic">Vic</option>
                <option value="å¶¸æ…¶">å¶¸æ…¶</option>
                <option value="å¨å…¨">å¨å…¨</option>
                <option value="Howard">Howard</option> 
                <option value="å“æ·©">å“æ·©</option>
                <option value="Alice">Alice</option>
                <option value="å…¶ä»–">æ‰‹å‹•è¼¸å…¥...</option>
            </select>
            <input type="text" id="staff-name-manual" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„å§“å" style="display:none; margin-top:10px;">
            <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="confirmStaff()">ç¢ºå®šé€²å…¥</button>
        </div>
    </div>

    <div id="court-selection-page" class="page">
        <div id="current-judge-display" style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">è£åˆ¤ï¼šæœªç™»éŒ„</div>
        <h2 style="margin-bottom: 20px;">é¸æ“‡è¨ˆåˆ†å ´åœ°</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; width:100%; max-width:450px;">
            <button class="court-btn" id="court-btn-1" onclick="selectCourt('1')">å ´åœ° 1</button>
            <button class="court-btn" id="court-btn-2" onclick="selectCourt('2')">å ´åœ° 2</button>
            <button class="court-btn" id="court-btn-3" onclick="selectCourt('3')">å ´åœ° 3</button>
            <button class="court-btn" id="court-btn-4" onclick="selectCourt('4')">å ´åœ° 4</button>
            <button class="court-btn" id="court-btn-5" onclick="selectCourt('5')">å ´åœ° 5</button>
            <button class="court-btn" id="court-btn-6" onclick="selectCourt('6')">å ´åœ° 6</button>
        </div>
    </div>

    <div id="pre-game-page" class="page">
        <h2 id="pre-game-title" style="text-align: center; color: var(--primary); margin-bottom: 25px;">å ´åœ°è¨­å®š</h2>
        <div class="admin-box">
            <label>éšŠä¼ A</label>
            <select id="teamA-names" onchange="checkManualName('A')">
                <option value="">-- è«‹é¸æ“‡é¸æ‰‹/éšŠä¼ --</option>
                <option value="é¸æ‰‹1">é¸æ‰‹1</option>
                <option value="é¸æ‰‹2">é¸æ‰‹2</option>
                <option value="manual">-- æ‰‹å‹•è¼¸å…¥ --</option>
            </select>
            <input type="text" id="teamA-manual" placeholder="è«‹è¼¸å…¥é¸æ‰‹å§“å" style="display:none; margin-top:5px;">

            <div style="text-align:center; margin:10px 0; font-weight:bold; opacity:0.5;">VS</div>

            <label>éšŠä¼ B</label>
            <select id="teamB-names" onchange="checkManualName('B')">
                <option value="">-- è«‹é¸æ“‡é¸æ‰‹/éšŠä¼ --</option>
                <option value="é¸æ‰‹3">é¸æ‰‹3</option>
                <option value="é¸æ‰‹4">é¸æ‰‹4</option>
                <option value="manual">-- æ‰‹å‹•è¼¸å…¥ --</option>
            </select>
            <input type="text" id="teamB-manual" placeholder="è«‹è¼¸å…¥é¸æ‰‹å§“å" style="display:none; margin-top:5px;">
            <div class="input-group" style="margin-top: 30px; margin-bottom: 30px;"> 
                <label style="margin-bottom: 12px; display: block;">ç›®å‰æ¯”è³½è¦å‰‡</label>
                <div id="current-rule-display" style="
                    background: #f8f9fa; 
                    padding: 18px; 
                    border-radius: 15px; 
                    text-align: center; 
                    font-weight: bold; 
                    color: var(--text-main);
                    border: 1px solid #eee;
                    font-size: 1.2rem;
                    box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
                ">
                    è¼‰å…¥è¦å‰‡ä¸­...
                </div>
                <input type="hidden" id="target-score-select" value="11">
            </div>
            
            <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="startMatch()">é–‹å§‹æ¯”è³½</button>
        </div>
    </div>

    <div id="scoring-page" class="page">
        <div id="current-set-label" style="background:var(--accent); padding:5px 15px; border-radius:15px; font-weight:bold; margin-bottom:10px;">ç¬¬ 1 å±€</div>
        <div class="scoreboard">
            <div style="display: flex; justify-content: space-between; align-items: center; position: relative; width: 100%;">
                <div style="flex: 1; text-align: center;">
                    <div id="set-won-A" style="font-weight:bold; color:var(--secondary);">Sets: 0</div>
                    <div id="dot-A" class="serving-dot"></div>
                    <div id="score-A" class="score-num" onclick="addScore('A')">0</div>
                    <div id="display-nameA" style="font-weight:bold; margin-top:10px;">A éšŠ</div>
                </div>
                <div style="width: 80px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;">
                    <div style="font-weight: 900; opacity: 0.8; font-size: 1.8rem;">VS</div>
                    <div id="deuce-indicator" class="deuce-text">DEUCE</div>
                </div>
                <div style="flex: 1; text-align: center;">
                    <div id="set-won-B" style="font-weight:bold; color:var(--secondary);">Sets: 0</div>
                    <div id="dot-B" class="serving-dot"></div>
                    <div id="score-B" class="score-num" onclick="addScore('B')">0</div>
                    <div id="display-nameB" style="font-weight:bold; margin-top:10px;">B éšŠ</div>
                </div>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; max-width: 500px; margin-top: 20px;">
            <button class="btn btn-outline" onclick="undo()">â†©ï¸ æ¢å¾©</button>
            <button class="btn btn-outline" onclick="switchSide()">ğŸ”„ æ›å ´</button>
            <button class="btn btn-outline" onclick="manualServe()">ğŸ¸ ç™¼çƒæ¬Š</button>
            <button class="btn btn-secondary" onclick="resetMatch()">âš ï¸ é‡è¨­</button>
        </div>
        <button class="btn btn-gray" style="width: 100%; max-width: 500px;" onclick="clearCourtData()">ğŸ”š çµæŸä¸¦æ¸…ç©ºå ´åœ°</button>
    </div>

    <div id="player-hub-page" class="page">
        <h1 style="color:var(--primary);">è³½äº‹è³‡è¨Šå¤§å»³</h1>
        <div class="admin-box" style="text-align:center; margin-bottom:20px;">
            <h3 id="announcement-text" style="margin:0;">è¼‰å…¥å…¬å‘Šä¸­...</h3>
            <img id="schedule-img-display" src="" style="max-width: 90%; max-height: 400px; border-radius: 12px; display: none; cursor: zoom-in; margin-top: 10px;">
            <div id="zoom-hint" style="display:none; font-size: 0.8rem; color: #888;">ğŸ” é»æ“Šåœ–ç‰‡æ”¾å¤§</div>
        </div>
        <div style="display: flex; align-items: center; justify-content: center; margin: 20px 0;">
            <span class="live-dot"></span>
            <h2 style="color: #4ecdc4; margin: 0; font-size: 1.2rem;">LIVE å³æ™‚è³½æ³</h2>
        </div>
        <div id="live-scoreboard-grid" style="width: 100%; max-width: 500px;"></div>
    </div>

    <div id="image-viewer" class="overlay" onclick="this.style.display='none'">
        <img id="full-size-image" src="" style="max-width:95%; max-height:95%; border-radius:10px;">
    </div>

    <div id="admin-master-page" class="page">
        <h2>ğŸ› ï¸ ç®¡ç†å¾Œå°</h2>
        <div class="admin-box">
            <h4>1. é¦–é ã€å…¬å‘Šã€è³½ç¨‹åœ–</h4>
            <input type="text" id="admin-home-img-url" placeholder="Logo åœ–ç‰‡ç¶²å€">
            <textarea id="admin-announcement" placeholder="å…¬å‘Šå…§å®¹"></textarea>
            <input type="text" id="admin-img-url" placeholder="è³½ç¨‹åœ–ç¶²å€">
            <button class="btn btn-primary" style="width:100%;" onclick="publishNotice()">ç™¼å¸ƒ</button>
            <hr>
            <h4>2. å…¨å ´åˆ†æ•¸è¦å‰‡</h4>
            <select id="rule-score-target" style="width:100%; margin-bottom:10px;">
                <option value="11" selected>11 åˆ†åˆ¶</option>
                <option value="15">15 åˆ†åˆ¶</option>
                <option value="21">21 åˆ†åˆ¶</option>
                <option value="25">25 åˆ†åˆ¶</option>
                <option value="31">31 åˆ†åˆ¶</option>
            </select>
            <button class="btn btn-secondary" style="width:100%;" onclick="updateAllCourtsRule()">å¥—ç”¨å…¨å ´</button>
            <hr>
            <h4>3. å…¨åŸŸå±€æ•¸è¨­å®š</h4>
            <select id="admin-global-sets">
                <option value="1">ä¸€å±€å®šå‹è² </option>
                <option value="3" selected>ä¸‰æˆ°å…©å‹</option>
            </select>
            <button class="btn btn-primary" style="width:100%;" onclick="saveGlobalSettings()">å„²å­˜å±€æ•¸</button>
        </div>
    </div>

    <button id="global-back-btn" class="back-fab" onclick="smartBack()">è¿”å›</button>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDgc6S2B_27murqz4nqEaSGDiwSonOn0ZE",
        authDomain: "vic-badminton-final.firebaseapp.com",
        projectId: "vic-badminton-final",
        storageBucket: "vic-badminton-final.firebasestorage.app",
        messagingSenderId: "440667114938",
        appId: "1:440667114938:web:6dd16da85f8e592438a183"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentCourt = null;
    let loggedJudge = "";
    const courtList = ['1', '2', '3', '4', '5', '6'];

    window.showPage = (id) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
        document.getElementById(id).classList.add('active-page');
        document.getElementById('global-back-btn').style.display = (id === 'home-page') ? 'none' : 'flex';
    };

    window.smartBack = () => {
        // å–å¾—ç›®å‰ç•«é¢ä¸Šå¸¶æœ‰ active-page é¡åˆ¥çš„é é¢ ID
        const currentPage = document.querySelector('.page.active-page')?.id;

        switch (currentPage) {
            case 'staff-verify-page': // å·¥ä½œäººå“¡ç™»å…¥é 
                showPage('home-page');
                break;
                
            case 'staff-select-page': // è£åˆ¤ç™»è¨˜é 
                showPage('staff-verify-page');
                break;
                
            case 'court-selection-page': // é¸æ“‡è¨ˆåˆ†å ´åœ°é 
                showPage('staff-select-page');
                break;

            case 'pre-game-page': // å ´åœ°è¨­å®šé 
                showPage('court-selection-page');
                break;

            case 'scoring-page': // è¨ˆåˆ†é 
                if(confirm("æ¯”è³½æ­£åœ¨é€²è¡Œä¸­ï¼Œç¢ºå®šè¦çµæŸè¨ˆåˆ†ä¸¦è¿”å›å ´åœ°é¸æ“‡å—ï¼Ÿ")) {
                    showPage('court-selection-page');
                }
                break;

            case 'player-hub-page': // é¸æ‰‹/è§€çœ¾å¤§å»³
            case 'admin-master-page': // ç®¡ç†å¾Œå°
                showPage('home-page');
                break;

            default:
                showPage('home-page');
                break;
        }
    };
    window.verifyStaff = () => { if(document.getElementById('staff-pass').value === '0000') showPage('staff-select-page'); else alert('å¯†ç¢¼éŒ¯èª¤'); };
    window.adminLogin = () => { if(prompt("ç®¡ç†å¯†ç¢¼") === '9999') showPage('admin-master-page'); };

    window.confirmStaff = () => {
        const sel = document.getElementById('staff-name-list').value;
        loggedJudge = (sel === 'å…¶ä»–') ? document.getElementById('staff-name-manual').value : sel;
        if(!loggedJudge) return alert("è«‹è¼¸å…¥å§“å");
        document.getElementById('current-judge-display').innerText = `è£åˆ¤ï¼š${loggedJudge}`;
        showPage('court-selection-page');
    };

    // é¸å ´åœ°é‚è¼¯
    window.selectCourt = async (id) => {
        currentCourt = id;
        listenToCourt(id);
        const ref = doc(db, "games", id);
        const snap = await getDoc(ref);
        
        if(snap.exists() && snap.data().nameA !== "æº–å‚™ä¸­") {
            showPage('scoring-page');
        } else {
            // 1. æŠ“å–å¾Œå°å…¨åŸŸè¨­å®š
            const configSnap = await getDoc(doc(db, "config", "match_settings"));
            const globalSets = configSnap.exists() ? configSnap.data().defaultTotalSets : 3;
            const globalScore = snap.exists() ? (snap.data().targetScore || 11) : 11;

            // 2. æ›´æ–°éš±è—çš„æ•¸å€¼èˆ‡é¡¯ç¤ºæ–‡å­—
            document.getElementById('target-score-select').value = globalScore;
            document.getElementById('current-rule-display').innerText = `${globalScore} åˆ†åˆ¶`;

            // 3. æ›´æ–°æ¨™é¡Œ (å ´åœ° X è¨­å®š...)
            const titleEl = document.getElementById('pre-game-title');
            if(titleEl) {
                titleEl.innerText = `å ´åœ° ${id} è¨­å®š (${globalSets} å±€å®šå‹è² , ${globalScore} åˆ†åˆ¶)`;
            }
            
            showPage('pre-game-page');
        }
    };

    window.updatePreGameTitle = async () => {
        try {
            const configSnap = await getDoc(doc(db, "config", "match_settings"));
            const globalSets = configSnap.exists() ? configSnap.data().defaultTotalSets : 3;
            const scoreVal = document.getElementById('target-score-select').value;
            document.getElementById('pre-game-title').innerText = `å ´åœ° ${currentCourt} è¨­å®š (${globalSets}å±€åˆ¶, ${scoreVal}åˆ†åˆ¶)`;
        } catch (e) { console.log(e); }
    };

    window.startMatch = async () => {
        // --- é€™è£¡å°±æ˜¯ä½ å•çš„é‚£æ®µé‚è¼¯ï¼Œç›´æ¥æ•´åˆé€²ä¾†äº† ---
        const getFinalName = (teamId) => {
            const sel = document.getElementById(`team${teamId}-names`).value;
            const manual = document.getElementById(`team${teamId}-manual`).value;
            // å¦‚æœé¸å–®é¸ã€Œmanualã€å°±ç”¨æ‰‹å‹•è¼¸å…¥çš„å€¼ï¼Œå¦å‰‡ç”¨é¸å–®çš„å€¼
            return (sel === 'manual') ? (manual || `è‡ªå®šç¾©é¸æ‰‹ ${teamId}`) : (sel || `${teamId} éšŠ`);
        };

        const nA = document.getElementById('teamA-names').value || "A éšŠ";
        const nB = document.getElementById('teamB-names').value || "B éšŠ";
        const target = parseInt(document.getElementById('target-score-select').value);
        try {
            const configSnap = await getDoc(doc(db, "config", "match_settings"));
            const globalSets = configSnap.exists() ? configSnap.data().defaultTotalSets : 3;
            await updateDoc(doc(db, "games", currentCourt), {
                nameA: nA, nameB: nB, scoreA: 0, scoreB: 0, setsA: 0, setsB: 0,
                currentSet: 1, totalSets: globalSets, targetScore: target,
                server: 'A', history: [], isWaitingNext: false, judgeName: loggedJudge
            });
            showPage('scoring-page');
        } catch (e) { alert("å•Ÿå‹•å¤±æ•—"); }
    };

    function listenToCourt(id) {
        onSnapshot(doc(db, "games", id), (snap) => {
            if (snap.exists() && currentCourt === id) {
                const d = snap.data();
                const target = d.targetScore || 11;
                // 1. å–å¾—åˆ†æ•¸å…ƒç´ 
                const scoreAEl = document.getElementById('score-A');
                const scoreBEl = document.getElementById('score-B');
                
                // 2. æ›´æ–°åˆ†æ•¸æ•¸å­—
                scoreAEl.innerText = d.scoreA;
                scoreBEl.innerText = d.scoreB;
                
                // --- æ–°å¢ï¼šè®Šè‰²é‚è¼¯ (Game Point è®Šç´…) ---
                // åˆ¤æ–· A æ˜¯å¦ç‚ºè³½é»ï¼šåˆ†æ•¸ >= target-1 ä¸”é ˜å…ˆ B
                const isGamePointA = (d.scoreA >= target - 1 && d.scoreA > d.scoreB);
                // åˆ¤æ–· B æ˜¯å¦ç‚ºè³½é»ï¼šåˆ†æ•¸ >= target-1 ä¸”é ˜å…ˆ A
                const isGamePointB = (d.scoreB >= target - 1 && d.scoreB > d.scoreA);
                
                // è¨­å®šé¡è‰²ï¼šè³½é»è®Šç´…è‰² (--secondary)ï¼Œå¦å‰‡ç¶­æŒæ·±è‰² (--text-main)
                scoreAEl.style.color = isGamePointA ? "var(--secondary)" : "var(--text-main)";
                scoreBEl.style.color = isGamePointB ? "var(--secondary)" : "var(--text-main)";
                // ---------------------------------------
                document.getElementById('score-A').innerText = d.scoreA;
                document.getElementById('score-B').innerText = d.scoreB;
                document.getElementById('display-nameA').innerText = d.nameA;
                document.getElementById('display-nameB').innerText = d.nameB;
                document.getElementById('set-won-A').innerText = `Sets: ${d.setsA || 0}`;
                document.getElementById('set-won-B').innerText = `Sets: ${d.setsB || 0}`;
                document.getElementById('current-set-label').innerText = `ç¬¬ ${d.currentSet} å±€ (${target}åˆ†åˆ¶)`;
                
                document.getElementById('dot-A').className = d.server === 'A' ? 'serving-dot serving-active' : 'serving-dot';
                document.getElementById('dot-B').className = d.server === 'B' ? 'serving-dot serving-active' : 'serving-dot';
                
                const isDeuce = (d.scoreA >= target - 1 && d.scoreA === d.scoreB);
                document.getElementById('deuce-indicator').style.display = isDeuce ? 'block' : 'none';

                if(d.isWaitingNext) {
                    document.getElementById('winner-text').innerText = `${d.scoreA > d.scoreB ? d.nameA : d.nameB} ç²å‹ï¼`;
                    document.getElementById('final-score-display').innerText = `${d.scoreA} : ${d.scoreB}`;
                    document.getElementById('game-over-overlay').style.display = 'flex';
                } else {
                    document.getElementById('game-over-overlay').style.display = 'none';
                }
            }
        });
    }

    window.addScore = async (team) => {
        const ref = doc(db, "games", currentCourt);
        const d = (await getDoc(ref)).data();
        const t = d.targetScore || 11;
        const h = d.history || [];
        h.push({scoreA: d.scoreA, scoreB: d.scoreB, server: d.server});
        let nA = (team === 'A') ? d.scoreA + 1 : d.scoreA;
        let nB = (team === 'B') ? d.scoreB + 1 : d.scoreB;
        const win = (nA >= t && nA - nB >= 2) || (nB >= t && nB - nA >= 2) || nA === 30 || nB === 30;
        await updateDoc(ref, { scoreA: nA, scoreB: nB, server: team, isWaitingNext: win, history: h });
    };

    window.undo = async () => {
        const ref = doc(db, "games", currentCourt);
        const d = (await getDoc(ref)).data();
        if (!d.history || d.history.length === 0) return;
        const last = d.history.pop();
        await updateDoc(ref, { scoreA: last.scoreA, scoreB: last.scoreB, server: last.server, isWaitingNext: false, history: d.history });
    };

    window.confirmNextSet = async () => {
        const ref = doc(db, "games", currentCourt);
        const d = (await getDoc(ref)).data();
        let nSetsA = d.setsA || 0;
        let nSetsB = d.setsB || 0;
        if (d.scoreA > d.scoreB) nSetsA++; else nSetsB++;
        const total = d.totalSets || 3;
        const threshold = Math.ceil(total / 2);

        if (nSetsA >= threshold || nSetsB >= threshold) {
            alert(`æ¯”è³½çµæŸï¼æ­å–œ ${nSetsA >= threshold ? d.nameA : d.nameB} ç²å‹ï¼`);
            await clearCourtData(true);
        } else {
            await updateDoc(ref, { setsA: nSetsA, setsB: nSetsB, scoreA: 0, scoreB: 0, currentSet: d.currentSet + 1, isWaitingNext: false, history: [] });
        }
    };

    window.clearCourtData = async (auto = false) => {
        if(auto || confirm("ç¢ºå®šæ¸…ç©ºå ´åœ°ï¼Ÿ")) {
            await setDoc(doc(db, "games", currentCourt), { nameA: "æº–å‚™ä¸­", nameB: "æº–å‚™ä¸­", scoreA: 0, scoreB: 0, setsA: 0, setsB: 0, currentSet: 1, judgeName: "", history: [], isWaitingNext: false, server: 'A' });
            showPage('court-selection-page');
        }
    };

    window.resetMatch = async () => { if(confirm("é‡è¨­æœ¬å±€ï¼Ÿ")) await updateDoc(doc(db, "games", currentCourt), { scoreA: 0, scoreB: 0, history: [], isWaitingNext: false }); };
    window.manualServe = async () => { const ref = doc(db, "games", currentCourt); const d = (await getDoc(ref)).data(); await updateDoc(ref, { server: d.server==='A'?'B':'A' }); };
    window.switchSide = async () => {
        const ref = doc(db, "games", currentCourt);
        const d = (await getDoc(ref)).data();
        await updateDoc(ref, { nameA: d.nameB, nameB: d.nameA, scoreA: d.scoreB, scoreB: d.scoreA, setsA: d.setsB, setsB: d.setsA, server: d.server==='A'?'B':'A' });
    };

    window.saveGlobalSettings = async () => {
        const s = parseInt(document.getElementById('admin-global-sets').value);
        await setDoc(doc(db, "config", "match_settings"), { defaultTotalSets: s }, { merge: true });
        alert("å„²å­˜æˆåŠŸ");
    };

    window.updateAllCourtsRule = async () => {
        const targetScore = parseInt(document.getElementById('rule-score-target').value);
        const courtList = ["1", "2", "3", "4", "5", "6"];
        
        try {
            const promises = courtList.map(id => 
                updateDoc(doc(db, "games", id), { targetScore: targetScore })
            );
            await Promise.all(promises);
            
            // åŒæ™‚å­˜å…¥ configï¼Œè®“ä»¥å¾Œæ–°é–‹çš„æ¯”è³½ä¹Ÿèƒ½æŠ“åˆ°é è¨­å€¼
            await setDoc(doc(db, "config", "match_settings"), { 
                defaultTargetScore: targetScore 
            }, { merge: true });

            alert(`âœ… å·²æˆåŠŸå°‡å…¨å ´åˆ†æ•¸çµ±ä¸€è¨­å®šç‚º ${targetScore} åˆ†åˆ¶`);
        } catch (e) {
            console.error(e);
            alert("âŒ å¥—ç”¨å¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™åº«æ¬Šé™");
        }
    };
    window.checkManualName = (type) => {
        let sel, manualInput;
        
        if (type === 'staff') {
            // è£åˆ¤ç™»è¨˜é é¢çš„ ID
            sel = document.getElementById('staff-name-list');
            manualInput = document.getElementById('staff-name-manual');
        } else {
            // é¸æ‰‹é¸æ“‡é é¢çš„ ID (A æˆ– B)
            sel = document.getElementById(`team${type}-names`);
            manualInput = document.getElementById(`team${type}-manual`);
        }
        
        if (sel && manualInput) {
            // è£åˆ¤é¸ã€Œå…¶ä»–ã€æˆ–é¸æ‰‹é¸ã€Œmanualã€æ™‚é¡¯ç¤º
            const isManual = (sel.value === 'å…¶ä»–' || sel.value === 'manual');
            manualInput.style.display = isManual ? 'block' : 'none';
            if (isManual) manualInput.focus();
        }
    };

    window.publishNotice = async () => {
        const h = document.getElementById('admin-home-img-url').value;
        const a = document.getElementById('admin-announcement').value;
        const i = document.getElementById('admin-img-url').value;
        const data = {};
        if(h) data.homeImg = h; if(a) data.content = a; if(i) data.imgUrl = i;
        await setDoc(doc(db, "config", "announcement"), data, { merge: true });
        alert("ç™¼å¸ƒæˆåŠŸ");
    };

    // å¤§å»³ç›£è½
    onSnapshot(doc(db, "config", "announcement"), (snap) => {
        if(snap.exists()){
            const d = snap.data();
            if(d.homeImg) document.getElementById('home-logo-display').innerHTML = `<img src="${d.homeImg}" style="max-height:180px;">`;
            document.getElementById('announcement-text').innerText = d.content || "æ­¡è¿åƒåŠ æ¯”è³½";
            
            const sImg = document.getElementById('schedule-img-display');
            if(d.imgUrl) { 
                sImg.src = d.imgUrl; 
                // ä¿®æ”¹é‡é»ï¼šå¼·åˆ¶åœ–ç‰‡é¡¯ç¤ºç‚º block ä¸¦é€é margin ç½®ä¸­
                sImg.style.cssText = "display: block; max-width: 95%; max-height: 400px; border-radius: 12px; cursor: zoom-in; margin: 15px auto 0 auto;";
                
                sImg.onclick = () => { 
                    document.getElementById('full-size-image').src = d.imgUrl; 
                    document.getElementById('image-viewer').style.display = 'flex'; 
                };
                document.getElementById('zoom-hint').style.display = 'block';
                // ç¢ºä¿æç¤ºæ–‡å­—ä¹Ÿç½®ä¸­
                document.getElementById('zoom-hint').style.textAlign = 'center';
            } else {
                sImg.style.display = 'none';
                document.getElementById('zoom-hint').style.display = 'none';
            }
        }
    });

    courtList.forEach(id => {
        onSnapshot(doc(db, "games", id), (snap) => {
            const grid = document.getElementById('live-scoreboard-grid');
            let card = document.getElementById(`hub-card-${id}`);
            if(!card) { 
                card = document.createElement('div'); 
                card.id = `hub-card-${id}`; 
                card.className = 'hub-card'; 
                grid.appendChild(card); 
            }

            if(snap.exists()){
                const d = snap.data();
                const isReady = (d.nameA === "æº–å‚™ä¸­");
                const target = d.targetScore || 11;

                // 1. è³½é»è®Šè‰²é‚è¼¯ (ä»»ä¸€æ–¹é”æ¨™å‰‡å…©é‚Šè®Šç´…)
                const isAnyGP = (d.scoreA >= target - 1 || d.scoreB >= target - 1);
                const scoreColor = isAnyGP ? "var(--secondary)" : "var(--primary)";

                // 2. å±€æ•¸æ¯”å­—ä¸² (åªé¡¯ç¤ºæ•¸å­—æ¯”åˆ†ï¼Œä¸åŠ  Sets å­—æ¨£)
                const setsScoreText = `${d.setsA || 0} : ${d.setsB || 0}`;

                card.innerHTML = `
                    <div style="flex:1; display: flex; flex-direction: column; justify-content: space-between; padding-right: 10px;">
                        <div style="font-size:0.75rem; color:#888;">å ´åœ° ${id}</div>
                        
                        <div style="font-weight:bold; font-size:1.15rem; color:var(--text-main); margin: 2px 0;">
                            ${d.nameA} ${isReady ? '' : '<span style="font-size:0.8rem; color:#999; margin:0 4px;">vs</span> ' + d.nameB}
                        </div>

                        <div style="font-size: 1rem; font-weight: 800; color: #555; height: 1.5rem; display: flex; align-items: center;">
                            ${isReady ? 
                                '<span style="font-size:0.9rem; color:#bbb;">READY</span>' : 
                                '<span style="font-size:0.8rem; color:#999; margin-right:5px; font-weight:normal;">å±€æ•¸æ¯”:</span>' + (d.setsA || 0) + ' : ' + (d.setsB || 0)
                            }
                        </div>
                    </div>

                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: space-between; min-width: 100px; border-left: 1px solid #f0f0f0; padding-left: 10px;">
                        <div style="height: 0.75rem;"></div> <div style="font-size:1.9rem; font-weight:900; display: flex; align-items: center; line-height: 1.2;">
                            <span style="color:${scoreColor}">${d.scoreA}</span>
                            <span style="color:#ccc; margin: 0 6px; font-size: 1.3rem;">:</span>
                            <span style="color:${scoreColor}">${d.scoreB}</span>
                        </div>
                        
                        <div style="font-size: 0.7rem; color: #999; height: 1.5rem; display: flex; align-items: center; white-space: nowrap;">
                            ${isReady ? '' : 'è£åˆ¤: ' + (d.judgeName || 'ç„¡')}
                        </div>
                    </div>`;
                
                card.style.opacity = isReady ? "0.6" : "1";
                
                const btn = document.getElementById(`court-btn-${id}`);
                if(btn) btn.style.borderColor = isReady ? "#eee" : "var(--secondary)";
            }
        });
    });
</script>
</body>
</html>

